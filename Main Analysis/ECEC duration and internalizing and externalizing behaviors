

#############################################################################################################
#############################################################################################################
############################# Regression models #############################################################

# Project: Childcare attendance duration and children's internalizing and externalizing behavior
# Script purpose: regression models all cohorts
# Author: Katharine Barry 
# Email: Katharine.Barry@inserm.fr

#load libraries
library(DSMolgenisArmadillo)
library(dsBaseClient)
library(dsHelper)
library(DSI)
library(DSOpal)

#login to all cohorts

## tokens
tokenelfe <- armadillo.get_token("https://armadillo.sicopre.elfe-france.fr")
tokeneden <- armadillo.get_token("https://armadillo.sicopre.elfe-france.fr")
tokenalspac <- armadillo.get_token("https://alspac-armadillo.molgenis.org")
#### login

builder <- DSI::newDSLoginBuilder()
#ALSPAC
builder$append(
  server = "alspac",
  url = "https://alspac-armadillo.molgenis.org",
  token = tokenalspac,
  driver = "ArmadilloDriver")

#GEN R
builder$append(server = "generationR", 
               url = "https://opal.erasmusmc.nl", user = "", 
               password = "",
               driver = "OpalDriver")

# DNBC
builder$append(server = "dnbc",
               url = "https://opal.sund.ku.dk",
               user ="",
               password= "",
               driver = "OpalDriver" )
#EDEN
builder$append(server ="eden",
               url="https://armadillo.sicopre.elfe-france.fr",
               token=tokeneden,
               driver="ArmadilloDriver")
# INMA
builder$append(server = "INMA", 
               url = "https://opal.isglobal.org/repo", 
               user = "", 
               password = "",
               driver = "OpalDriver",
               profile='rock-inma')
# ELFE
builder$append(server ="elfe",
               url="https://armadillo.sicopre.elfe-france.fr",
               token=tokenelfe,
               driver="ArmadilloDriver")

# NINFEA
builder$append(server = "ninfea", 
               url = "https://www.lifecycle.unito.it", 
               user = "", 
               password = "",
               driver = "OpalDriver")
# all login
logindata <- builder$build()
c.data <- DSI::datashield.login(logins = logindata, restore="strata_new")


####################### age bracket 5-6 years old ################################################
##################################################################################################
########################## crude model ###########################################################
ds.meanSdGp(
  x = "int_data$n.int_pc_.5_7",
  y = "int_data$f.cen_dur_cat.5_7",
  type = "split",
  datasources = c.data[c('alspac','generationR','elfe', 'eden')])
ds.table('int_data$f.cen_dur_cat.5_7', exclude=NA, datasources = c.data[c('alspac','generationR','eden','elfe')])
#alspac

ds.table('int_data$f.cen_dur_cat.5_7', exclude=NA, datasources=c.data[c('alspac','generationR','eden','elfe')])

int_5_6_crude_alspac <- ds.glm(formula = "n.int_pc_.5_7 ~ f.cen_dur_cat.5_7",
                               data = "int_data",
                               family = "gaussian",
                               datasources = c.data[c('alspac')])
int_5_6_crude_alspac

dh.lmTab(
  model = int_5_6_crude_alspac, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")

#genr
int_5_6_crude_genr <- ds.glm(formula = "n.int_pc_.5_7 ~ f.cen_dur_cat.5_7",
                             data = "int_data",
                             family = "gaussian",
                             datasources = c.data[c('generationR')])

dh.lmTab(
  model = int_5_6_crude_genr, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")
int_5_6_crude_genr

#eden 

int_5_6_crude_eden <- ds.glm(formula = "n.int_pc_.5_7 ~ f.cen_dur_cat.5_7",
                             data = "int_data",
                             family = "gaussian",
                             datasources = c.data[c('eden')])
dh.lmTab(
  model = int_5_6_crude_eden, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")


int_5_6_crude_eden

#elfe

int_5_6_crude_elfe <- ds.glm(formula = "n.int_pc_.5_7 ~ f.cen_dur_cat.5_7",
                             data = "int_data",
                             family = "gaussian",
                             datasources = c.data[c('elfe')])
dh.lmTab(
  model = int_5_6_crude_elfe, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")

int_5_6_crude_elfe

estint_5_6_1 <-c((int_5_6_crude_alspac$coefficients["f.cen_dur_cat.5_71", "Estimate"]),
                 (int_5_6_crude_genr$coefficients["f.cen_dur_cat.5_71", "Estimate"]),
                 (int_5_6_crude_eden$coefficients["f.cen_dur_cat.5_71", "Estimate"]),
                 (int_5_6_crude_elfe$coefficients["f.cen_dur_cat.5_71", "Estimate"]),
                 
                 (int_5_6_crude_genr$coefficients["f.cen_dur_cat.5_72", "Estimate"]),
                 (int_5_6_crude_eden$coefficients["f.cen_dur_cat.5_72", "Estimate"]),
                 (int_5_6_crude_elfe$coefficients["f.cen_dur_cat.5_72", "Estimate"]))



estint_5_6_1

# overall standard errors
seint_5_6_1 <-c((int_5_6_crude_alspac$coefficients["f.cen_dur_cat.5_71", "Std. Error"]), 
                (int_5_6_crude_genr$coefficients["f.cen_dur_cat.5_71", "Std. Error"]),
                (int_5_6_crude_eden$coefficients["f.cen_dur_cat.5_71", "Std. Error"]),
                (int_5_6_crude_elfe$coefficients["f.cen_dur_cat.5_71", "Std. Error"]),
                
                (int_5_6_crude_genr$coefficients["f.cen_dur_cat.5_72", "Std. Error"]),
                (int_5_6_crude_eden$coefficients["f.cen_dur_cat.5_72", "Std. Error"]),
                (int_5_6_crude_elfe$coefficients["f.cen_dur_cat.5_72", "Std. Error"]))




resintcrude5_6 <- metafor::rma(yi=estint_5_6_1, sei=seint_5_6_1)
resintcrude5_6
library('metafor')

mlabfundur5_6 <- function(text, resintcrude5_6) {
  list(bquote(paste(.(text),
                    ": Q = ", .(formatC(resintcrude5_6$QE, digits=2, format="f")),
                    ", df = ", .(resintcrude5_6$k - resintcrude5_6$p),
                    ", p ", .(metafor:::.pval(resintcrude5_6$QEp, digits=2, showeq=TRUE, sep=" ")), "; ",
                    I^2, " = ", .(formatC(resintcrude5_6$I2, digits=1, format="f")), "%, ",
                    tau^2, " = ", .(formatC(resintcrude5_6$tau2, digits=2, format="f")),";",
                    H^2, " = ", .(formatC(resintcrude5_6$H2, digits=2, format="f")))))}



forest(resintcrude5_6, showweights=FALSE,rows=c(8:5,3:1), cex=1.2, cex.lab=1, xlim=c(-60,30),
       addfit = FALSE,
       psize=1, header="Cohort study (N= Attended ECEC, %)",slab=c("ALSPAC (N=99, 6.39%)", "GenR (N=863, 60.26%)", "EDEN (N=202, 27.26 %)", "ELFE (N=2291, 21.14%)", "GenR (N=63, 4.40%)", "EDEN (N=60, 8.10 %)", "ELFE (N=1006, 9.28%)"), font=4)

op <- par(cex=1.0, font=2)


### switch to bold italic font
par(font=4)

### add text for the subgroups
text(-60, c(8.4,3.4), pos=4, c("Only one year ECEC attendance",
                               "Two years or more ECEC attendance"))


### set par back to the original settings
par(op)



### subgroups estimates
i.sub1_5_6_cruest<-c((int_5_6_crude_alspac$coefficients["f.cen_dur_cat.5_71", "Estimate"]),
                     (int_5_6_crude_genr$coefficients["f.cen_dur_cat.5_71", "Estimate"]),
                     (int_5_6_crude_eden$coefficients["f.cen_dur_cat.5_71", "Estimate"]),
                     (int_5_6_crude_elfe$coefficients["f.cen_dur_cat.5_71", "Estimate"]))

i.sub2_5_6_cruest<-c((int_5_6_crude_genr$coefficients["f.cen_dur_cat.5_72", "Estimate"]),
                     (int_5_6_crude_eden$coefficients["f.cen_dur_cat.5_72", "Estimate"]),
                     (int_5_6_crude_elfe$coefficients["f.cen_dur_cat.5_72", "Estimate"]))


# subgroup standard errors
i.sub1_5_6_cruse<-c((int_5_6_crude_alspac$coefficients["f.cen_dur_cat.5_71", "Std. Error"]), 
                    (int_5_6_crude_genr$coefficients["f.cen_dur_cat.5_71", "Std. Error"]),
                    (int_5_6_crude_eden$coefficients["f.cen_dur_cat.5_71", "Std. Error"]),
                    (int_5_6_crude_elfe$coefficients["f.cen_dur_cat.5_71", "Std. Error"]))

i.sub2_5_6_cruse <-c((int_5_6_crude_genr$coefficients["f.cen_dur_cat.5_72", "Std. Error"]),
                     (int_5_6_crude_eden$coefficients["f.cen_dur_cat.5_72", "Std. Error"]),
                     (int_5_6_crude_elfe$coefficients["f.cen_dur_cat.5_72", "Std. Error"]))


### fit random-effects model in the four subgroups
i.res.1.5_6cru <- rma(yi=i.sub1_5_6_cruest,sei=i.sub1_5_6_cruse)
i.res.2.5_6cru <- rma(yi=i.sub2_5_6_cruest, sei=i.sub2_5_6_cruse)
#forest(i.res.1.5_6cru,showweights=TRUE)
#forest(i.res.2.5_6cru,showweights=TRUE)

addpoly(i.res.1.5_6cru,cex=1.2, cex.lab=1, row=4.0, mlab=mlabfundur5_6 ("RE Model for one year ECEC attendance", i.res.1.5_6cru))
addpoly(i.res.2.5_6cru,cex=1.2, cex.lab=1, row= 0.3, mlab=mlabfundur5_6 ("RE Model for two year ECEC attendance", i.res.2.5_6cru))



text(16, 10,cex=1.2,font=2, c("Weights (%)"))
text(16, 8,cex=1.2,font=1, c("5.75%"))
text(16, 7,cex=1.2,font=1, c("23.13%"))
text(16, 6,cex=1.2,font=1, c("10.53%"))
text(16, 5,cex=1.2,font=1, c("60.59%"))
text(16, 4,cex=1.2,font=1, c("100.00%"))

text(16, 3,cex=1.2,font=1, c("29.01%"))
text(16, 2,cex=1.2,font=1, c("27.39%"))
text(16, 1,cex=1.2,font=1, c("43.60%"))
text(16, 0.3,cex=1.2,font=1, c("100.00%"))

ds.table('int_data$f.cen_dur_cat.5_7')

#############################################################################################################
#############################################################################################################
#############################################################################################################

############################ adjusted model for 5 to 6 age bracket
ds.colnames('int_data')

int_5_6_adj_alspac <- ds.glm(formula = "n.int_pc_.5_7 ~ f.cen_dur_cat.5_7+ n.birth_weight.5_7+ n.agebirth_m_y.5_7+ f.fam_splitup.0.5_7+ f.only_child.5_7+ f.sex.5_7+ f.edu_m_.0.5_7+ f.mom.emp.dich.5_7",
                             data = "int_data",
                             family = "gaussian",
                             datasources = c.data[c('alspac')])
int_5_6_adj_alspac
dh.lmTab(
  model = int_5_6_adj_alspac, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")

#genr
int_5_6_adj_genr <- ds.glm(formula = "n.int_pc_.5_7 ~ f.cen_dur_cat.5_7+ n.birth_weight.5_7+ n.agebirth_m_y.5_7+ f.fam_splitup.0.5_7+ f.only_child.5_7+ f.sex.5_7+ f.edu_m_.0.5_7+ f.femp_cat_mom_0.5_7",
                           data = "int_data",
                           family = "gaussian",
                           datasources = c.data[c('generationR')])

dh.lmTab(
  model = int_5_6_adj_genr, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")

#eden

int_5_6_adj_eden <- ds.glm(formula = "n.int_pc_.5_7 ~ f.cen_dur_cat.5_7+ n.birth_weight.5_7+ n.agebirth_m_y.5_7+ f.fam_splitup.0.5_7+ f.only_child.5_7+ f.sex.5_7+ f.edu_m_.0.5_7+ f.femp_cat_mom_0.5_7",
                           data = "int_data",
                           family = "gaussian",
                           datasources = c.data[c('eden')])
dh.lmTab(
  model = int_5_6_adj_eden, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")


#elfe

int_5_6_adj_elfe <- ds.glm(formula = "n.int_pc_.5_7 ~ f.cen_dur_cat.5_7+ n.birth_weight.5_7+ n.agebirth_m_y.5_7+ f.fam_splitup.0.5_7+ f.only_child.5_7+ f.sex.5_7+ f.edu_m_.0.5_7+ f.femp_cat_mom_0.5_7",
                           data = "int_data",
                           family = "gaussian",
                           datasources = c.data[c('elfe')])
dh.lmTab(
  model = int_5_6_adj_elfe, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")
###############################################################################################################
###############################################################################################################
################################# Forest plot #################################################################
estint_5_6_1 <-c((int_5_6_adj_alspac$coefficients["f.cen_dur_cat.5_71", "Estimate"]),
                 (int_5_6_adj_genr$coefficients["f.cen_dur_cat.5_71", "Estimate"]),
                 (int_5_6_adj_eden$coefficients["f.cen_dur_cat.5_71", "Estimate"]),
                 (int_5_6_adj_elfe$coefficients["f.cen_dur_cat.5_71", "Estimate"]),
                 
                 (int_5_6_adj_genr$coefficients["f.cen_dur_cat.5_72", "Estimate"]),
                 (int_5_6_adj_eden$coefficients["f.cen_dur_cat.5_72", "Estimate"]),
                 (int_5_6_adj_elfe$coefficients["f.cen_dur_cat.5_72", "Estimate"]))



estint_5_6_1
# overall standard errors
seint_5_6_1 <-c((int_5_6_adj_alspac$coefficients["f.cen_dur_cat.5_71", "Std. Error"]), 
                (int_5_6_adj_genr$coefficients["f.cen_dur_cat.5_71", "Std. Error"]),
                (int_5_6_adj_eden$coefficients["f.cen_dur_cat.5_71", "Std. Error"]),
                (int_5_6_adj_elfe$coefficients["f.cen_dur_cat.5_71", "Std. Error"]),
                
                (int_5_6_adj_genr$coefficients["f.cen_dur_cat.5_72", "Std. Error"]),
                (int_5_6_adj_eden$coefficients["f.cen_dur_cat.5_72", "Std. Error"]),
                (int_5_6_adj_elfe$coefficients["f.cen_dur_cat.5_72", "Std. Error"]))



resintadj5_6 <- metafor::rma(yi=estint_5_6_1, sei=seint_5_6_1)
resintadj5_6
library('metafor')

mlabfundur5_6adj <- function(text, resintadj5_6) {
  list(bquote(paste(.(text),
                    ": Q = ", .(formatC(resintadj5_6$QE, digits=2, format="f")),
                    ", df = ", .(resintadj5_6$k - resintadj5_6$p),
                    ", p ", .(metafor:::.pval(resintadj5_6$QEp, digits=2, showeq=TRUE, sep=" ")), "; ",
                    I^2, " = ", .(formatC(resintadj5_6$I2, digits=1, format="f")), "%, ",
                    tau^2, " = ", .(formatC(resintadj5_6$tau2, digits=2, format="f")),";",
                    H^2, " = ", .(formatC(resintadj5_6$H2, digits=2, format="f")))))}



forest(resintadj5_6, showweights=FALSE,rows=c(8:5,3:1), cex=1.2, cex.lab=1, xlim=c(-60,30), addfit = FALSE,
       psize=1, header="Cohort study (N= Attended ECEC, %)",slab=c("ALSPAC (N=99, 6.39%)", "GenR (N=863, 60.26%)", "EDEN (N=202, 27.26 %)", "ELFE (N=2291, 21.14%)", "GenR (N=63, 4.40%)", "EDEN (N=60, 8.10 %)", "ELFE (N=1006, 9.28%)"), font=4)

op <- par(cex=1.0, font=2)


### switch to bold italic font
par(font=4)

### add text for the subgroups
text(-60, c(8.4,3.4), pos=4, c("Only one year ECEC attendance",
                               "Two years or more ECEC attendance"))


### set par back to the original settings
par(op)



### subgroups estimates
i.sub1_5_6_adjest<-c((int_5_6_adj_alspac$coefficients["f.cen_dur_cat.5_71", "Estimate"]),
                     (int_5_6_adj_genr$coefficients["f.cen_dur_cat.5_71", "Estimate"]),
                     (int_5_6_adj_eden$coefficients["f.cen_dur_cat.5_71", "Estimate"]),
                     (int_5_6_adj_elfe$coefficients["f.cen_dur_cat.5_71", "Estimate"]))

i.sub2_5_6_adjest <-c((int_5_6_adj_genr$coefficients["f.cen_dur_cat.5_72", "Estimate"]),
                      (int_5_6_adj_eden$coefficients["f.cen_dur_cat.5_72", "Estimate"]),
                      (int_5_6_adj_elfe$coefficients["f.cen_dur_cat.5_72", "Estimate"]))


# subgroup standard errors
i.sub1_5_6_adjse<-c((int_5_6_adj_alspac$coefficients["f.cen_dur_cat.5_71", "Std. Error"]), 
                    (int_5_6_adj_genr$coefficients["f.cen_dur_cat.5_71", "Std. Error"]),
                    (int_5_6_adj_eden$coefficients["f.cen_dur_cat.5_71", "Std. Error"]),
                    (int_5_6_adj_elfe$coefficients["f.cen_dur_cat.5_71", "Std. Error"]))

i.sub2_5_6_adjse <-c((int_5_6_adj_genr$coefficients["f.cen_dur_cat.5_72", "Std. Error"]),
                     (int_5_6_adj_eden$coefficients["f.cen_dur_cat.5_72", "Std. Error"]),
                     (int_5_6_adj_elfe$coefficients["f.cen_dur_cat.5_72", "Std. Error"]))


### fit random-effects model in the four subgroups
i.res.1.5_6adj <- rma(yi=i.sub1_5_6_adjest, sei=i.sub1_5_6_adjse)
i.res.1.5_6adj
i.res.2.5_6adj<- rma(yi=i.sub2_5_6_adjest,sei=i.sub2_5_6_adjse)
i.res.2.5_6adj
#forest(i.res.1.5_6adj,showweights=TRUE)

int_5_6_adj_alspac$coefficients

addpoly(i.res.1.5_6adj,cex=1.2, cex.lab=1, row=4.0, mlab=mlabfundur5_6adj ("RE Model for one year ECEC attendance", i.res.1.5_6adj))
# calculate weights
#forest(i.res.1.5_6adj,showweights=TRUE)

addpoly(i.res.2.5_6adj,cex=1.2, cex.lab=1, row= 0.4, mlab=mlabfundur5_6adj ("RE Model for two year ECEC attendance", i.res.2.5_6adj))
#forest(i.res.2.5_6adj,showweights=TRUE)


text(16, 10,cex=1.2,font=2, c("Weights (%)"))
text(16, 8,cex=1.2,font=1, c("3.51%"))
text(16, 7,cex=1.2,font=1, c("14.49%"))
text(16, 6,cex=1.2,font=1, c("6.81%"))
text(16, 5,cex=1.2,font=1, c("75.18%"))
text(16, 4,cex=1.2,font=1, c("100.00%"))

text(16, 3,cex=1.2,font=1, c("31.10%"))
text(16, 2,cex=1.2,font=1, c("30.14%"))
text(16, 1,cex=1.2,font=1, c("38.75%"))
text(16, 0.4,cex=1.2,font=1, c("100.00%"))


ds.table('int_data$f.cen_dur_cat.5_7')

##############################################################################
##############################################################################
########################### 7 to 9 year age bracket
#alspac


int_7_9_crude_alspac <- ds.glm(formula = "n.int_pc_.7_10 ~ f.cen_dur_cat.7_10",
                               data = "int_data",
                               family = "gaussian",
                               datasources = c.data[c('alspac')])
int_7_9_crude_alspac
dh.lmTab(
  model = int_7_9_crude_alspac, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")

#genr
int_7_9_crude_genr <- ds.glm(formula = "n.int_pc_.7_10 ~ f.cen_dur_cat.7_10",
                             data = "int_data",
                             family = "gaussian",
                             datasources = c.data[c('generationR')])
int_7_9_crude_genr
dh.lmTab(
  model = int_7_9_crude_genr, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")

#dnbc
int_7_9_crude_dnbc <- ds.glm(formula = "n.int_pc_.7_10 ~ f.cen_dur_cat.7_10",
                             data = "int_data",
                             family = "gaussian",
                             datasources = c.data[c('dnbc')])


dh.lmTab(
  model = int_7_9_crude_dnbc, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")
int_7_9_crude_dnbc
# INMA

int_7_9_crude_inma<- ds.glm(formula = "n.int_pc_.7_10 ~ f.cen_dur_cat.7_10",
                            data = "int_data",
                            family = "gaussian",
                            datasources = c.data[c('INMA')])


dh.lmTab(
  model = int_7_9_crude_inma, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")
int_7_9_crude_inma
# EDEN

int_7_9_crude_eden<- ds.glm(formula = "n.int_pc_.7_10 ~ f.cen_dur_cat.7_10",
                            data = "int_data",
                            family = "gaussian",
                            datasources = c.data[c('eden')])


dh.lmTab(
  model = int_7_9_crude_eden, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")
int_7_9_crude_eden
########################################################################################
########################################################################################
################### crude forest plot meta-analysis for age bracket 7-9 years###########

yint7_9 <-c((int_7_9_crude_alspac$coefficients["f.cen_dur_cat.7_101", "Estimate"]),
            (int_7_9_crude_genr$coefficients["f.cen_dur_cat.7_101", "Estimate"]),
            (int_7_9_crude_dnbc$coefficients["f.cen_dur_cat.7_101", "Estimate"]),
            (int_7_9_crude_inma$coefficients["f.cen_dur_cat.7_101", "Estimate"]),
            (int_7_9_crude_eden$coefficients["f.cen_dur_cat.7_101", "Estimate"]),
            
            
            (int_7_9_crude_genr$coefficients["f.cen_dur_cat.7_102", "Estimate"]),
            (int_7_9_crude_inma$coefficients["f.cen_dur_cat.7_102", "Estimate"]),
            (int_7_9_crude_eden$coefficients["f.cen_dur_cat.7_102", "Estimate"]))

yint7_9

seint7_9 <-c((int_7_9_crude_alspac$coefficients["f.cen_dur_cat.7_101", "Std. Error"]),
             (int_7_9_crude_genr$coefficients["f.cen_dur_cat.7_101", "Std. Error"]),
             (int_7_9_crude_dnbc$coefficients["f.cen_dur_cat.7_101", "Std. Error"]),
             (int_7_9_crude_inma$coefficients["f.cen_dur_cat.7_101", "Std. Error"]),
             (int_7_9_crude_eden$coefficients["f.cen_dur_cat.7_101", "Std. Error"]),
             
             
             (int_7_9_crude_genr$coefficients["f.cen_dur_cat.7_102", "Std. Error"]),
             (int_7_9_crude_inma$coefficients["f.cen_dur_cat.7_102", "Std. Error"]),
             (int_7_9_crude_eden$coefficients["f.cen_dur_cat.7_102", "Std. Error"]))


resint7_9 <- metafor::rma(yi=yint7_9, sei=seint7_9)
resint7_9
library('metafor')

mlabfun7_9 <- function(text, resint7_9) {
  list(bquote(paste(.(text),
                    ": Q = ", .(formatC(resint7_9$QE, digits=2, format="f")),
                    ", df = ", .(resint7_9$k - resint7_9$p),
                    ", p ", .(metafor:::.pval(resint7_9$QEp, digits=2, showeq=TRUE, sep=" ")), "; ",
                    I^2, " = ", .(formatC(resint7_9$I2, digits=1, format="f")), "%, ",
                    tau^2, " = ", .(formatC(resint7_9$tau2, digits=2, format="f")),";",
                    H^2, " = ", .(formatC(resint7_9$H2, digits=2, format="f")))))}
forest(resint7_9, showweights=FALSE,rows=c(9:5,3:1), cex=1.2, cex.lab=1, xlim=c(-60,30), addfit = FALSE,
       psize=1, header="Cohort study (N= Attended ECEC, %)",slab=c('ALSPAC (N=170, 6.35%)', 'GenR (N=800, 61.49%)', 'DNBC (N=7079, 24.90%)','INMA (N=322, 39.20%)', 'EDEN (N=98, 21.78%)', 'GenR (N=57, 4.38%)', 'INMA(N=360, 42.50%)', 'EDEN(N=52, 11.55%)'), font=4)


ds.table('int_data$f.cen_dur_cat.7_10', exclude=NA)


op <- par(cex=1.0, font=2)


### switch to bold italic font
par(font=4)

### add text for the subgroups
text(-60, c(9.4,3.4), pos=4, c("One Year ECEC attendance",
                               "Two Years or more ECEC attendance"))


### set par back to the original settings
par(op)



### subgroups estimates

i.sub1_7_9_cruest <-c((int_7_9_crude_alspac$coefficients["f.cen_dur_cat.7_101", "Estimate"]),
                      (int_7_9_crude_genr$coefficients["f.cen_dur_cat.7_101", "Estimate"]),
                      (int_7_9_crude_dnbc$coefficients["f.cen_dur_cat.7_101", "Estimate"]),
                      (int_7_9_crude_inma$coefficients["f.cen_dur_cat.7_101", "Estimate"]),
                      (int_7_9_crude_eden$coefficients["f.cen_dur_cat.7_101", "Estimate"]))


i.sub2_7_9_cruest<-c((int_7_9_crude_genr$coefficients["f.cen_dur_cat.7_102", "Estimate"]),
                     (int_7_9_crude_inma$coefficients["f.cen_dur_cat.7_102", "Estimate"]),
                     (int_7_9_crude_eden$coefficients["f.cen_dur_cat.7_102", "Estimate"]))

# subgroup standard errors

i.sub1_7_9_cruse <-c((int_7_9_crude_alspac$coefficients["f.cen_dur_cat.7_101", "Std. Error"]),
                     (int_7_9_crude_genr$coefficients["f.cen_dur_cat.7_101", "Std. Error"]),
                     (int_7_9_crude_dnbc$coefficients["f.cen_dur_cat.7_101", "Std. Error"]),
                     (int_7_9_crude_inma$coefficients["f.cen_dur_cat.7_101", "Std. Error"]),
                     (int_7_9_crude_eden$coefficients["f.cen_dur_cat.7_101", "Std. Error"]))


i.sub2_7_9_cruse<-c((int_7_9_crude_genr$coefficients["f.cen_dur_cat.7_102", "Std. Error"]),
                    (int_7_9_crude_inma$coefficients["f.cen_dur_cat.7_102", "Std. Error"]),
                    (int_7_9_crude_eden$coefficients["f.cen_dur_cat.7_102", "Std. Error"]))


### fit random-effects model in the four subgroups
i.res.1.7_9cru <- rma(yi=i.sub1_7_9_cruest,sei= i.sub1_7_9_cruse)
i.res.2.7_9cru <- rma(yi=i.sub2_7_9_cruest,sei= i.sub2_7_9_cruse)
# calculate weights
#forest(i.res.1.7_9cru,showweights=TRUE,cex=1.5)
#forest(i.res.2.7_9cru,showweights=TRUE,cex=1.5)

addpoly(i.res.1.7_9cru,cex=1.2, cex.lab=1, row=4.0, mlab=mlabfun7_9 ("RE Model for one year ECEC attendance", i.res.1.7_9cru))

addpoly(i.res.2.7_9cru,cex=1.2, cex.lab=1, row= 0.4, mlab=mlabfun7_9("RE Model for two year ECEC attendance", i.res.2.7_9cru))



text(16, 11,cex=1.2,font=2, c("Weights (%)"))
text(16, 9,cex=1.2,font=1, c("11.59%"))
text(16, 8,cex=1.2,font=1, c("22.93%"))
text(16, 7,cex=1.2,font=1, c("48.69%"))
text(16, 6,cex=1.2,font=1, c("9.33%"))
text(16, 5,cex=1.2,font=1, c("7.46%"))
text(16, 4,cex=1.2,font=1, c("100.00%"))



text(16, 3,cex=1.2,font=1, c("29.59%"))
text(16, 2,cex=1.2,font=1, c("48.60%"))
text(16, 1,cex=1.2,font=1, c("21.81%"))
text(16, 0.4,cex=1.2,font=1, c("100.00%"))


##########################################################################################################
##########################################################################################################
###################### Adjusted analysis #################################################################

int_7_9_adj_alspac <- ds.glm(formula = "n.int_pc_.7_10 ~ f.cen_dur_cat.7_10+ n.birth_weight.7_10+ n.agebirth_m_y.7_10+f.fam_splitup.0.7_10+ f.only_child.7_10+ f.sex.7_10+ f.edu_m_.0.7_10+ f.mom.emp.dich.7_10",
                             data = "int_data",
                             family = "gaussian",
                             datasources = c.data[c('alspac')])
int_7_9_adj_alspac

dh.lmTab(
  model = int_7_9_adj_alspac, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")

#genr
int_7_9_adj_genr <- ds.glm(formula = "n.int_pc_.7_10 ~ f.cen_dur_cat.7_10+ n.birth_weight.7_10+ n.agebirth_m_y.7_10+f.fam_splitup.0.7_10+ f.only_child.7_10+ f.sex.7_10+ f.edu_m_.0.7_10+ f.femp_cat_mom_0.7_10",
                           data = "int_data",
                           family = "gaussian",
                           datasources = c.data[c('generationR')])

dh.lmTab(
  model = int_7_9_adj_genr, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")

#dnbc
int_7_9_adj_dnbc <- ds.glm(formula = "n.int_pc_.7_10 ~ f.cen_dur_cat.7_10+f.fam_splitup.0.7_10+f.sex.7_10+f.femp_cat_mom_0.7_10+n.birth_weight.7_10+f.only_child.7_10+n.agebirth_m_y.7_10",
                           data = "int_data",
                           family = "gaussian",
                           datasources = c.data[c('dnbc')])


dh.lmTab(
  model = int_7_9_adj_dnbc, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")

# INMA

int_7_9_adj_inma <- ds.glm(formula = "n.int_pc_.7_10 ~ f.cen_dur_cat.7_10+ n.birth_weight.7_10+ n.agebirth_m_y.7_10+ f.only_child.7_10+ f.sex.7_10+ f.edu_m_.0.7_10+ f.femp_cat_mom_0.7_10",
                           data = "int_data",
                           family = "gaussian",
                           datasources = c.data[c('INMA')])


dh.lmTab(
  model = int_7_9_adj_inma, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")

# EDEN

int_7_9_adj_eden <- ds.glm(formula = "n.int_pc_.7_10 ~ f.cen_dur_cat.7_10+ n.birth_weight.7_10+ n.agebirth_m_y.7_10+f.fam_splitup.0.7_10+ f.only_child.7_10+ f.sex.7_10+ f.edu_m_.0.7_10+ f.femp_cat_mom_0.7_10",
                           data = "int_data",
                           family = "gaussian",
                           datasources = c.data[c('eden')])


dh.lmTab(
  model = int_7_9_adj_eden, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")

int_7_9_adj_eden

yint7_9adj <-c((int_7_9_adj_alspac$coefficients["f.cen_dur_cat.7_101", "Estimate"]),
               (int_7_9_adj_genr$coefficients["f.cen_dur_cat.7_101", "Estimate"]),
               (int_7_9_adj_dnbc$coefficients["f.cen_dur_cat.7_101", "Estimate"]),
               (int_7_9_adj_inma$coefficients["f.cen_dur_cat.7_101", "Estimate"]),
               (int_7_9_adj_eden$coefficients["f.cen_dur_cat.7_101", "Estimate"]),
               
               
               (int_7_9_adj_genr$coefficients["f.cen_dur_cat.7_102", "Estimate"]),
               (int_7_9_adj_inma$coefficients["f.cen_dur_cat.7_102", "Estimate"]),
               (int_7_9_adj_eden$coefficients["f.cen_dur_cat.7_102", "Estimate"]))

yint7_9adj

seint7_9adj <-c((int_7_9_adj_alspac$coefficients["f.cen_dur_cat.7_101", "Std. Error"]),
                (int_7_9_adj_genr$coefficients["f.cen_dur_cat.7_101", "Std. Error"]),
                (int_7_9_adj_dnbc$coefficients["f.cen_dur_cat.7_101", "Std. Error"]),
                (int_7_9_adj_inma$coefficients["f.cen_dur_cat.7_101", "Std. Error"]),
                (int_7_9_adj_eden$coefficients["f.cen_dur_cat.7_101", "Std. Error"]),
                
                
                (int_7_9_adj_genr$coefficients["f.cen_dur_cat.7_102", "Std. Error"]),
                (int_7_9_adj_inma$coefficients["f.cen_dur_cat.7_102", "Std. Error"]),
                (int_7_9_adj_eden$coefficients["f.cen_dur_cat.7_102", "Std. Error"]))


resint7_9adj <- metafor::rma(yi=yint7_9adj, sei=seint7_9adj)
resint7_9adj

mlabfun7_9 <- function(text, resint7_9adj) {
  list(bquote(paste(.(text),
                    ": Q = ", .(formatC(resint7_9adj$QE, digits=2, format="f")),
                    ", df = ", .(resint7_9adj$k - resint7_9adj$p),
                    ", p ", .(metafor:::.pval(resint7_9adj$QEp, digits=2, showeq=TRUE, sep=" ")), "; ",
                    I^2, " = ", .(formatC(resint7_9adj$I2, digits=1, format="f")), "%, ",
                    tau^2, " = ", .(formatC(resint7_9adj$tau2, digits=2, format="f")),";",
                    H^2, " = ", .(formatC(resint7_9adj$H2, digits=2, format="f")))))}


forest(resint7_9adj, showweights=FALSE,rows=c(9:5,3:1), cex=1.2, cex.lab=1, xlim=c(-60,30), addfit = FALSE,
       psize=1, header="Cohort study (N= Attended ECEC, %)",slab=c('ALSPAC (N=170, 6.35%)', 'GenR (N=800, 61.49%)', 'DNBC (N=7079, 24.90%)','INMA (N=322, 39.20%)', 'EDEN (N=98, 21.78%)', 'GenR (N=57, 4.38%)', 'INMA(N=360, 42.50%)', 'EDEN(N=52, 11.55%)'), font=4)


ds.table('int_data$f.cen_dur_cat.7_10')


op <- par(cex=1.0, font=2)


### switch to bold italic font
par(font=4)

### add text for the subgroups
text(-60, c(9.4,3.4), pos=4, c("One Year ECEC attendance",
                               "Two Years or more ECEC attendance"))


### set par back to the original settings
par(op)



### subgroups estimates

i.sub1_7_9_adjest <-c((int_7_9_adj_alspac$coefficients["f.cen_dur_cat.7_101", "Estimate"]),
                      (int_7_9_adj_genr$coefficients["f.cen_dur_cat.7_101", "Estimate"]),
                      (int_7_9_adj_dnbc$coefficients["f.cen_dur_cat.7_101", "Estimate"]),
                      (int_7_9_adj_inma$coefficients["f.cen_dur_cat.7_101", "Estimate"]),
                      (int_7_9_adj_eden$coefficients["f.cen_dur_cat.7_101", "Estimate"]))


i.sub2_7_9_adjest<-c((int_7_9_adj_genr$coefficients["f.cen_dur_cat.7_102", "Estimate"]),
                     (int_7_9_adj_inma$coefficients["f.cen_dur_cat.7_102", "Estimate"]),
                     (int_7_9_adj_eden$coefficients["f.cen_dur_cat.7_102", "Estimate"]))

# subgroup standard errors

i.sub1_7_9_adjse <-c((int_7_9_adj_alspac$coefficients["f.cen_dur_cat.7_101", "Std. Error"]),
                     (int_7_9_adj_genr$coefficients["f.cen_dur_cat.7_101", "Std. Error"]),
                     (int_7_9_adj_dnbc$coefficients["f.cen_dur_cat.7_101", "Std. Error"]),
                     (int_7_9_adj_inma$coefficients["f.cen_dur_cat.7_101", "Std. Error"]),
                     (int_7_9_adj_eden$coefficients["f.cen_dur_cat.7_101", "Std. Error"]))


i.sub2_7_9_adjse<-c((int_7_9_adj_genr$coefficients["f.cen_dur_cat.7_102", "Std. Error"]),
                    (int_7_9_adj_inma$coefficients["f.cen_dur_cat.7_102", "Std. Error"]),
                    (int_7_9_adj_eden$coefficients["f.cen_dur_cat.7_102", "Std. Error"]))



### fit random-effects model in the four subgroups
i.res.1.7_9adj <- rma(yi=i.sub1_7_9_adjest, sei=i.sub1_7_9_adjse)
i.res.2.7_9adj <- rma(yi=i.sub2_7_9_adjest, sei=i.sub2_7_9_adjse)
# calculate weights
#forest(i.res.1.7_9adj,showweights=TRUE,cex=1.5)
#forest(i.res.2.7_9adj,showweights=TRUE,cex=1.5)

addpoly(i.res.1.7_9adj,cex=1.2, cex.lab=1, row=4.0, mlab=mlabfun7_9 ("RE Model for one year ECEC attendance", i.res.1.7_9adj))

addpoly(i.res.2.7_9adj,cex=1.2, cex.lab=1, row= 0.4, mlab=mlabfun7_9("RE Model for two year ECEC attendance",i.res.2.7_9adj))



text(16, 11,cex=1.2,font=2, c("Weights (%)"))
text(16, 9,cex=1.2,font=1, c("12.72%"))
text(16, 8,cex=1.2,font=1, c("21.05%"))
text(16, 7,cex=1.2,font=1, c("46.57%"))
text(16, 6,cex=1.2,font=1, c("10.84%"))
text(16, 5,cex=1.2,font=1, c("8.83%"))
text(16, 4,cex=1.2,font=1, c("100.00%"))



text(16, 3,cex=1.2,font=1, c("28.75%"))
text(16, 2,cex=1.2,font=1, c("48.51%"))
text(16, 1,cex=1.2,font=1, c("22.74%"))
text(16, 0.4,cex=1.2,font=1, c("100.00%"))


#################################### 10 to 12 years old information #######################################

#alspac


int_10_13_crude_alspac <- ds.glm(formula = "n.int_pc_.10_14 ~ f.cen_dur_cat.10_14",
                                 data = "int_data",
                                 family = "gaussian",
                                 datasources = c.data[c('alspac')])
int_10_13_crude_alspac
dh.lmTab(
  model = int_10_13_adj_alspac, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")

#genr ### does not have enough in two years or more to look at so have to use created variable

ds.asNumeric('int_data$f.cen_dur_cat.10_14', newobj='genR1year.10_14', datasources=c.data[c('generationR')])

ds.recodeValues(var.name='genR1year.10_14', 
                values2replace.vector = c(2),
                new.values.vector = c(NA), newobj='genr1year.10_14', datasources=c.data[c('generationR')])

ds.dataFrame(x=c('int_data', "genr1year.10_14"), newobj='int_data', datasources=c.data[c('generationR')])

ds.table('int_data$genr1year.10_14', datasources=c.data[c('generationR')])


int_10_13_crude_genr <- ds.glm(formula = "n.int_pc_.10_14 ~ genr1year.10_14",
                               data = "int_data",
                               family = "gaussian",
                               datasources = c.data[c('generationR')])

ds.table('int_data$genr1year.10_14', exclude=NA, datasources = c.data[c('generationR')])

ds.table('int_data$f.cen_dur_cat.10_14', exclude=NA)

int_10_13_crude_genr
dh.lmTab(
  model = int_10_13_crude_genr, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")

#dnbc
int_10_13_crude_dnbc <- ds.glm(formula = "n.int_pc_.10_14 ~ f.cen_dur_cat.10_14",
                               data = "int_data",
                               family = "gaussian",
                               datasources = c.data[c('dnbc')])

int_10_13_crude_dnbc
dh.lmTab(
  model = int_10_13_crude_dnbc, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")

# INMA

int_10_13_crude_inma <- ds.glm(formula = "n.int_pc_.10_14 ~ f.cen_dur_cat.10_14",
                               data = "int_data",
                               family = "gaussian",
                               datasources = c.data[c('INMA')])

int_10_13_crude_inma
dh.lmTab(
  model = int_10_13_crude_inma, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")

# INMA

int_10_13_crude_ninfea <- ds.glm(formula = "n.int_pc_.10_14 ~ f.cen_dur_cat.10_14",
                                 data = "int_data",
                                 family = "gaussian",
                                 datasources = c.data[c('ninfea')])

int_10_13_crude_ninfea
dh.lmTab(
  model = int_10_13_crude_ninfea, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")


yint10_13 <-c((int_10_13_crude_alspac$coefficients["f.cen_dur_cat.10_141", "Estimate"]),
              (int_10_13_crude_genr$coefficients["genr1year.10_14", "Estimate"]),
              (int_10_13_crude_dnbc$coefficients["f.cen_dur_cat.10_141", "Estimate"]),
              (int_10_13_crude_inma$coefficients["f.cen_dur_cat.10_141", "Estimate"]),
              (int_10_13_crude_ninfea$coefficients["f.cen_dur_cat.10_141", "Estimate"]),
              
              
              
              (int_10_13_crude_inma$coefficients["f.cen_dur_cat.10_142", "Estimate"]))

yint10_13

seint10_13 <-c((int_10_13_crude_alspac$coefficients["f.cen_dur_cat.10_141", "Std. Error"]),
               (int_10_13_crude_genr$coefficients["genr1year.10_14", "Std. Error"]),
               (int_10_13_crude_dnbc$coefficients["f.cen_dur_cat.10_141", "Std. Error"]),
               (int_10_13_crude_inma$coefficients["f.cen_dur_cat.10_141", "Std. Error"]),
               (int_10_13_crude_ninfea$coefficients["f.cen_dur_cat.10_141", "Std. Error"]),
               
               
               
               (int_10_13_crude_inma$coefficients["f.cen_dur_cat.10_142", "Std. Error"]))

resint10_13 <- metafor::rma(yi=yint10_13, sei=seint10_13)
resint10_13
library('metafor')
mlabfun10_13 <- function(text, resint10_13) {
  list(bquote(paste(.(text),
                    ": Q = ", .(formatC(resint10_13$QE, digits=2, format="f")),
                    ", df = ", .(resint10_13$k - resint10_13$p),
                    ", p ", .(metafor:::.pval(resint10_13$QEp, digits=2, showeq=TRUE, sep=" ")), "; ",
                    I^2, " = ", .(formatC(resint10_13$I2, digits=1, format="f")), "%, ",
                    tau^2, " = ", .(formatC(resint10_13$tau2, digits=2, format="f")),";",
                    H^2, " = ", .(formatC(resint10_13$H2, digits=2, format="f")))))}

ds.table('int_data$f.cen_dur_cat.10_14', exclude=NA)
ds.table('int_data$f.centre_care.10_14', exclude=NA)



forest(resint10_13,showweights=FALSE,rows=c(7:3,1), cex=1.2, cex.lab=1, xlim=c(-90,60), addfit = FALSE,
       psize=1, header="Cohort study (N= Attended ECEC, %)",slab=c('ALSPAC (N=58, 5.32%)', 'GenR (N=61, 59.20%)', 'DNBC (N=5957, 26.54%)','INMA (N=177, 45.27%)', 'NINFEA (N=18, 30.51%)', 'INMA(N=167, 42.71%)'), font=4)



op <- par(cex=1.0, font=2)


### switch to bold italic font
par(font=4)

### add text for the subgroups
text(-90, c(7.4,1.4), pos=4, c("One Year ECEC attendance",
                               "Two Years or more ECEC attendance"))


### set par back to the original settings
par(op)



### subgroups estimates


i.sub1_10_13_cruest<-c((int_10_13_crude_alspac$coefficients["f.cen_dur_cat.10_141", "Estimate"]),
                       (int_10_13_crude_genr$coefficients["genr1year.10_14", "Estimate"]),
                       (int_10_13_crude_dnbc$coefficients["f.cen_dur_cat.10_141", "Estimate"]),
                       (int_10_13_crude_inma$coefficients["f.cen_dur_cat.10_141", "Estimate"]),
                       (int_10_13_crude_ninfea$coefficients["f.cen_dur_cat.10_141", "Estimate"]))

i.sub2_10_13_cruest<-int_10_13_crude_inma$coefficients["f.cen_dur_cat.10_142", "Estimate"]


i.sub1_10_13_cruse <-c((int_10_13_crude_alspac$coefficients["f.cen_dur_cat.10_141", "Std. Error"]),
                       (int_10_13_crude_genr$coefficients["genr1year.10_14", "Std. Error"]),
                       (int_10_13_crude_dnbc$coefficients["f.cen_dur_cat.10_141", "Std. Error"]),
                       (int_10_13_crude_inma$coefficients["f.cen_dur_cat.10_141", "Std. Error"]),
                       (int_10_13_crude_ninfea$coefficients["f.cen_dur_cat.10_141", "Std. Error"]))


i.sub2_10_13_cruse<-int_10_13_crude_inma$coefficients["f.cen_dur_cat.10_142", "Std. Error"]








### fit random-effects model in the four subgroups
i.res.1.10_13cru <- rma(yi=i.sub1_10_13_cruest, sei=i.sub1_10_13_cruse)
# calculate weights
#forest(i.res.1.10_13cru,showweights=TRUE,cex=1.5)
i.res.2.10_13cru <- rma(yi=i.sub2_10_13_cruest, sei=i.sub2_10_13_cruse)

addpoly(i.res.1.10_13cru,cex=1.2, cex.lab=1, row=2, mlab=mlabfun10_13 ("RE Model for one year ECEC attendance", i.res.1.10_13cru))




text(38, 9,cex=1.2,font=2, c("Weights (%)"))
text(38,7,cex=1.2,font=1, c("19.87%"))
text(38,6,cex=1.2,font=1, c("15.13%"))
text(38,5,cex=1.2,font=1, c("40.84%"))
text(38, 4,cex=1.2,font=1, c("16.52%"))
text(38, 3,cex=1.2,font=1, c("7.64%"))
text(38, 2,cex=1.2,font=1, c("100.00%"))
text(38, 1,cex=1.2,font=1, c("100.00%"))




################### adjusted model ###############################################################################

#alspac


int_10_13_adj_alspac <- ds.glm(formula = "n.int_pc_.10_14 ~ f.cen_dur_cat.10_14+ n.birth_weight.10_14+ n.agebirth_m_y.10_14+ f.fam_splitup.0.10_14+f.only_child.10_14+ f.sex.10_14+ f.edu_m_.0.10_14+ f.mom.emp.dich.10_14",
                               data = "int_data",
                               family = "gaussian",
                               datasources = c.data[c('alspac')])
int_10_13_adj_alspac
dh.lmTab(
  model = int_10_13_adj_alspac, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")

#genr
int_10_13_adj_genr <- ds.glm(formula = "n.int_pc_.10_14 ~ genr1year.10_14+ n.birth_weight.10_14+ n.agebirth_m_y.10_14+ f.fam_splitup.0.10_14+f.only_child.10_14+ f.sex.10_14+ f.edu_m_.0.10_14+ f.femp_cat_mom_0.10_14",
                             data = "int_data",
                             family = "gaussian",
                             datasources = c.data[c('generationR')])

dh.lmTab(
  model = int_10_13_adj_genr, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")

#dnbc
int_10_13_adj_dnbc <- ds.glm(formula = "n.int_pc_.10_14 ~ f.cen_dur_cat.10_14+ n.birth_weight.10_14+ n.agebirth_m_y.10_14+ f.fam_splitup.0.10_14+f.only_child.10_14+ f.sex.10_14+ f.edu_m_.0.10_14+ f.femp_cat_mom_0.10_14",
                             data = "int_data",
                             family = "gaussian",
                             datasources = c.data[c('dnbc')])


dh.lmTab(
  model = int_10_13_adj_dnbc, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")

# INMA

int_10_13_adj_inma <- ds.glm(formula = "n.int_pc_.10_14 ~ f.cen_dur_cat.10_14+ n.birth_weight.10_14+ n.agebirth_m_y.10_14+f.only_child.10_14+ f.sex.10_14+ f.edu_m_.0.10_14+ f.femp_cat_mom_0.10_14",
                             data = "int_data",
                             family = "gaussian",
                             datasources = c.data[c('INMA')])


dh.lmTab(
  model = int_10_13_adj_inma, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")

# NINFEA  ### too low cell count to include mother's education

int_10_13_adj_ninfea <- ds.glm(formula = "n.int_pc_.10_14 ~ f.cen_dur_cat.10_14+ n.birth_weight.10_14+ n.agebirth_m_y.10_14+f.only_child.10_14+ f.sex.10_14+ f.femp_cat_mom_0.10_14",
                               data = "int_data",
                               family = "gaussian",
                               datasources = c.data[c('ninfea')])


dh.lmTab(
  model = int_10_13_adj_inma, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")

yint10_13adj <-c((int_10_13_adj_alspac$coefficients["f.cen_dur_cat.10_141", "Estimate"]),
                 (int_10_13_adj_genr$coefficients["genr1year.10_14", "Estimate"]),
                 (int_10_13_adj_dnbc$coefficients["f.cen_dur_cat.10_141", "Estimate"]),
                 (int_10_13_adj_inma$coefficients["f.cen_dur_cat.10_141", "Estimate"]),
                 (int_10_13_adj_ninfea$coefficients["f.cen_dur_cat.10_141", "Estimate"]),
                 
                 
                 
                 (int_10_13_adj_inma$coefficients["f.cen_dur_cat.10_142", "Estimate"]))

yint10_13adj

seint10_13adj <-c((int_10_13_adj_alspac$coefficients["f.cen_dur_cat.10_141", "Std. Error"]),
                  (int_10_13_adj_genr$coefficients["genr1year.10_14", "Std. Error"]),
                  (int_10_13_adj_dnbc$coefficients["f.cen_dur_cat.10_141", "Std. Error"]),
                  (int_10_13_adj_inma$coefficients["f.cen_dur_cat.10_141", "Std. Error"]),
                  (int_10_13_adj_ninfea$coefficients["f.cen_dur_cat.10_141", "Std. Error"]),
                  
                  
                  
                  (int_10_13_adj_inma$coefficients["f.cen_dur_cat.10_142", "Std. Error"]))



resint10_13adj <- metafor::rma(yi=yint10_13adj, sei=seint10_13adj)
resint10_13adj

mlabfun10_13adj <- function(text, resint10_13adj) {
  list(bquote(paste(.(text),
                    ": Q = ", .(formatC(resint10_13adj$QE, digits=2, format="f")),
                    ", df = ", .(resint10_13adj$k - resint10_13adj$p),
                    ", p ", .(metafor:::.pval(resint10_13adj$QEp, digits=2, showeq=TRUE, sep=" ")), "; ",
                    I^2, " = ", .(formatC(resint10_13adj$I2, digits=1, format="f")), "%, ",
                    tau^2, " = ", .(formatC(resint10_13adj$tau2, digits=2, format="f")),";",
                    H^2, " = ", .(formatC(resint10_13adj$H2, digits=2, format="f")))))}

forest(resint10_13adj,showweights=FALSE,rows=c(7:3,1), cex=1.2, cex.lab=1, xlim=c(-80,60), addfit = FALSE,
       psize=1, , header="Cohort study (N= Attended ECEC, %)",slab=c('ALSPAC (N=58, 5.32%)', 'GenR (N=61, 59.20%)', 'DNBC (N=5957, 26.54%)','INMA (N=177, 45.27%)', 'NINFEA (N=18, 30.51%)', 'INMA(N=167, 42.71%)'), font=4)



op <- par(cex=1.0, font=2)


### switch to bold italic font
par(font=4)

### add text for the subgroups
text(-80, c(7.4,1.4), pos=4, c("One Year ECEC attendance",
                               "Two Years or more ECEC attendance"))


### set par back to the original settings
par(op)



### subgroups estimates


i.sub1_10_13_adjest<-c((int_10_13_adj_alspac$coefficients["f.cen_dur_cat.10_141", "Estimate"]),
                       (int_10_13_adj_genr$coefficients["genr1year.10_14", "Estimate"]),
                       (int_10_13_adj_dnbc$coefficients["f.cen_dur_cat.10_141", "Estimate"]),
                       (int_10_13_adj_inma$coefficients["f.cen_dur_cat.10_141", "Estimate"]),
                       (int_10_13_adj_ninfea$coefficients["f.cen_dur_cat.10_141", "Estimate"]))


i.sub2_10_13_adjest <-(int_10_13_adj_inma$coefficients["f.cen_dur_cat.10_142", "Estimate"])


i.sub1_10_13_adjse <-c((int_10_13_adj_alspac$coefficients["f.cen_dur_cat.10_141", "Std. Error"]),
                       (int_10_13_adj_genr$coefficients["genr1year.10_14", "Std. Error"]),
                       (int_10_13_adj_dnbc$coefficients["f.cen_dur_cat.10_141", "Std. Error"]),
                       (int_10_13_adj_inma$coefficients["f.cen_dur_cat.10_141", "Std. Error"]),
                       (int_10_13_adj_ninfea$coefficients["f.cen_dur_cat.10_141", "Std. Error"]))


i.sub2_10_13_adjse <-(int_10_13_adj_inma$coefficients["f.cen_dur_cat.10_142", "Std. Error"])





### fit random-effects model in the four subgroups
i.res.1.10_13adj <- rma(yi=i.sub1_10_13_adjest,sei= i.sub1_10_13_adjse)
# calculate weights
#forest(i.res.1.10_13adj,showweights=TRUE,cex=1.5)

addpoly(i.res.1.10_13adj,cex=1.2, cex.lab=1, row=2.0, mlab=mlabfun10_13adj ("RE Model for one year ECEC attendance", i.res.1.10_13adj))
i.res.2.10_13adj <- rma(yi=i.sub2_10_13_adjest,sei= i.sub2_10_13_adjse)





text(35, 9,cex=1.2,font=2, c("Weights (%)"))
text(35, 7,cex=1.2,font=1, c("21.11%"))
text(35, 6,cex=1.2,font=1, c("12.52%"))
text(35, 5,cex=1.2,font=1, c("41.80%"))

text(35, 4,cex=1.2,font=1, c("17.88%"))
text(35, 3,cex=1.2,font=1, c("6.68%"))
text(35, 2,cex=1.2,font=1, c("100.00%"))
text(35, 1,cex=1.2,font=1, c("100.00%"))










###########################################################################################################
###########################################################################################################
################################ externalizing behavior ###################################################



#############################################################################################################
#############################################################################################################
############################# Regression models #############################################################

# Project: Childcare attendance duration and children's externalizing and externalizing behavior
# Script purpose: regression models all cohorts
#Author: Katharine Barry 
# Email: Katharine.Barry@inserm.fr
#load libraries



####################### age bracket 5-6 years old ################################################
##################################################################################################
########################## crude model ###########################################################
ds.colnames('ext_data')

ds.meanSdGp(
  x = "ext_data$n.ext_pc_.5_7",
  y = "ext_data$f.cen_dur_cat.5_7",
  type = "split",
  datasources = c.data[c('alspac','generationR','elfe', 'eden')])
ds.table('ext_data$f.cen_dur_cat.5_7', exclude=NA, datasources = c.data[c('alspac','generationR','eden','elfe')])
#alspac

ds.table('ext_data$f.cen_dur_cat.5_7', exclude=NA, datasources=c.data[c('alspac','generationR','elfe')])

ext_5_6_crude_alspac <- ds.glm(formula = "n.ext_pc_.5_7 ~ f.cen_dur_cat.5_7",
                               data = "ext_data",
                               family = "gaussian",
                               datasources = c.data[c('alspac')])
ext_5_6_crude_alspac

dh.lmTab(
  model = ext_5_6_crude_alspac, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")

#genr
ext_5_6_crude_genr <- ds.glm(formula = "n.ext_pc_.5_7 ~ f.cen_dur_cat.5_7",
                             data = "ext_data",
                             family = "gaussian",
                             datasources = c.data[c('generationR')])

dh.lmTab(
  model = ext_5_6_crude_genr, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")
ext_5_6_crude_genr

#eden 

ext_5_6_crude_eden <- ds.glm(formula = "n.ext_pc_.5_7 ~ f.cen_dur_cat.5_7",
                             data = "ext_data",
                             family = "gaussian",
                             datasources = c.data[c('eden')])
dh.lmTab(
  model = ext_5_6_crude_eden, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")


ext_5_6_crude_eden

#elfe

ext_5_6_crude_elfe <- ds.glm(formula = "n.ext_pc_.5_7 ~ f.cen_dur_cat.5_7",
                             data = "ext_data",
                             family = "gaussian",
                             datasources = c.data[c('elfe')])
dh.lmTab(
  model = ext_5_6_crude_elfe, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")

ext_5_6_crude_elfe

estext_5_6_1 <-c((ext_5_6_crude_alspac$coefficients["f.cen_dur_cat.5_71", "Estimate"]),
                 (ext_5_6_crude_genr$coefficients["f.cen_dur_cat.5_71", "Estimate"]),
                 (ext_5_6_crude_eden$coefficients["f.cen_dur_cat.5_71", "Estimate"]),
                 (ext_5_6_crude_elfe$coefficients["f.cen_dur_cat.5_71", "Estimate"]),
                 
                 (ext_5_6_crude_genr$coefficients["f.cen_dur_cat.5_72", "Estimate"]),
                 (ext_5_6_crude_eden$coefficients["f.cen_dur_cat.5_72", "Estimate"]),
                 (ext_5_6_crude_elfe$coefficients["f.cen_dur_cat.5_72", "Estimate"]))



estext_5_6_1
# overall standard errors
seext_5_6_1 <-c((ext_5_6_crude_alspac$coefficients["f.cen_dur_cat.5_71", "Std. Error"]), 
                (ext_5_6_crude_genr$coefficients["f.cen_dur_cat.5_71", "Std. Error"]),
                (ext_5_6_crude_eden$coefficients["f.cen_dur_cat.5_71", "Std. Error"]),
                (ext_5_6_crude_elfe$coefficients["f.cen_dur_cat.5_71", "Std. Error"]),
                
                (ext_5_6_crude_genr$coefficients["f.cen_dur_cat.5_72", "Std. Error"]),
                (ext_5_6_crude_eden$coefficients["f.cen_dur_cat.5_72", "Std. Error"]),
                (ext_5_6_crude_elfe$coefficients["f.cen_dur_cat.5_72", "Std. Error"]))




resextcrude5_6 <- metafor::rma(yi=estext_5_6_1, sei=seext_5_6_1)
resextcrude5_6
library('metafor')

mlabfundur5_6 <- function(text, resextcrude5_6) {
  list(bquote(paste(.(text),
                    ": Q = ", .(formatC(resextcrude5_6$QE, digits=2, format="f")),
                    ", df = ", .(resextcrude5_6$k - resextcrude5_6$p),
                    ", p ", .(metafor:::.pval(resextcrude5_6$QEp, digits=2, showeq=TRUE, sep=" ")), "; ",
                    I^2, " = ", .(formatC(resextcrude5_6$I2, digits=1, format="f")), "%, ",
                    tau^2, " = ", .(formatC(resextcrude5_6$tau2, digits=2, format="f")),";",
                    H^2, " = ", .(formatC(resextcrude5_6$H2, digits=2, format="f")))))}



forest(resextcrude5_6, showweights=FALSE,rows=c(8:5,3:1), cex=1.2, cex.lab=1, xlim=c(-60,30),
       addfit = FALSE,
       psize=1, header="Cohort study (N= Attended ECEC, %)",slab=c("ALSPAC (N=99, 6.39%)", "GenR (N=866, 60.26%)", "EDEN (N=203, 27.36 %)", "ELFE (N=2292, 21.15%)", "GenR (N=63, 4.38%)", "EDEN (N=60, 8.09 %)", "ELFE (N=1006, 9.28%)"), font=4)

op <- par(cex=1.0, font=2)


### switch to bold italic font
par(font=4)

### add text for the subgroups
text(-60, c(8.4,3.4), pos=4, c("Only one year ECEC attendance",
                               "Two years or more ECEC attendance"))


### set par back to the original settings
par(op)



### subgroups estimates
e.sub1_5_6_cruest<-c((ext_5_6_crude_alspac$coefficients["f.cen_dur_cat.5_71", "Estimate"]),
                     (ext_5_6_crude_genr$coefficients["f.cen_dur_cat.5_71", "Estimate"]),
                     (ext_5_6_crude_eden$coefficients["f.cen_dur_cat.5_71", "Estimate"]),
                     (ext_5_6_crude_elfe$coefficients["f.cen_dur_cat.5_71", "Estimate"]))

e.sub2_5_6_cruest <-c((ext_5_6_crude_genr$coefficients["f.cen_dur_cat.5_72", "Estimate"]),
                      (ext_5_6_crude_eden$coefficients["f.cen_dur_cat.5_72", "Estimate"]),
                      (ext_5_6_crude_elfe$coefficients["f.cen_dur_cat.5_72", "Estimate"]))


# subgroup standard errors
e.sub1_5_6_cruse<-c((ext_5_6_crude_alspac$coefficients["f.cen_dur_cat.5_71", "Std. Error"]), 
                    (ext_5_6_crude_genr$coefficients["f.cen_dur_cat.5_71", "Std. Error"]),
                    (ext_5_6_crude_eden$coefficients["f.cen_dur_cat.5_71", "Std. Error"]),
                    (ext_5_6_crude_elfe$coefficients["f.cen_dur_cat.5_71", "Std. Error"]))

e.sub2_5_6_cruse<-c((ext_5_6_crude_genr$coefficients["f.cen_dur_cat.5_72", "Std. Error"]),
                    (ext_5_6_crude_eden$coefficients["f.cen_dur_cat.5_72", "Std. Error"]),
                    (ext_5_6_crude_elfe$coefficients["f.cen_dur_cat.5_72", "Std. Error"]))


### fit random-effects model in the four subgroups
e.res.1.5_6cru <- rma(yi=e.sub1_5_6_cruest, sei=e.sub1_5_6_cruse)
e.res.2.5_6cru <- rma(yi=e.sub2_5_6_cruest, sei=e.sub2_5_6_cruse)
#forest(e.res.1.5_6cru,showweights=TRUE)
#forest(e.res.2.5_6cru,showweights=TRUE)

addpoly(e.res.1.5_6cru,cex=1.2, cex.lab=1, row=4.0, mlab=mlabfundur5_6 ("RE Model for one year ECEC attendance", e.res.1.5_6cru))
addpoly(e.res.2.5_6cru,cex=1.2, cex.lab=1, row= 0.3, mlab=mlabfundur5_6 ("RE Model for two year ECEC attendance", e.res.2.5_6cru))



text(16, 10,cex=1.2,font=2, c("Weights (%)"))
text(16, 8,cex=1.2,font=1, c("9.57%"))
text(16, 7,cex=1.2,font=1, c("26.79%"))
text(16, 6,cex=1.2,font=1, c("14.09%"))
text(16, 5,cex=1.2,font=1, c("49.56%"))
text(16, 4,cex=1.2,font=1, c("100.00%"))

text(16, 3,cex=1.2,font=1, c("30.50%"))
text(16, 2,cex=1.2,font=1, c("29.06%"))
text(16, 1,cex=1.2,font=1, c("40.44%"))
text(16, 0.3,cex=1.2,font=1, c("100.00%"))

ds.table('ext_data$f.cen_dur_cat.5_7')

#############################################################################################################
#############################################################################################################
#############################################################################################################

############################ adjusted model for 5 to 6 age bracket
ds.colnames('ext_data')

ext_5_6_adj_alspac <- ds.glm(formula = "n.ext_pc_.5_7 ~ f.cen_dur_cat.5_7+ n.birth_weight.5_7+ n.agebirth_m_y.5_7+ f.fam_splitup.0.5_7+ f.only_child.5_7+ f.sex.5_7+ f.edu_m_.0.5_7+ f.mom.emp.dich.5_7",
                             data = "ext_data",
                             family = "gaussian",
                             datasources = c.data[c('alspac')])
ext_5_6_adj_alspac
dh.lmTab(
  model = ext_5_6_adj_alspac, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")

#genr
ext_5_6_adj_genr <- ds.glm(formula = "n.ext_pc_.5_7 ~ f.cen_dur_cat.5_7+ n.birth_weight.5_7+ n.agebirth_m_y.5_7+ f.fam_splitup.0.5_7+ f.only_child.5_7+ f.sex.5_7+ f.edu_m_.0.5_7+ f.femp_cat_mom_0.5_7",
                           data = "ext_data",
                           family = "gaussian",
                           datasources = c.data[c('generationR')])

dh.lmTab(
  model = ext_5_6_adj_genr, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")

#eden

ext_5_6_adj_eden <- ds.glm(formula = "n.ext_pc_.5_7 ~ f.cen_dur_cat.5_7+ n.birth_weight.5_7+ n.agebirth_m_y.5_7+ f.fam_splitup.0.5_7+ f.only_child.5_7+ f.sex.5_7+ f.edu_m_.0.5_7+ f.femp_cat_mom_0.5_7",
                           data = "ext_data",
                           family = "gaussian",
                           datasources = c.data[c('eden')])
dh.lmTab(
  model = ext_5_6_adj_eden, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")


#elfe

ext_5_6_adj_elfe <- ds.glm(formula = "n.ext_pc_.5_7 ~ f.cen_dur_cat.5_7+ n.birth_weight.5_7+ n.agebirth_m_y.5_7+ f.fam_splitup.0.5_7+ f.only_child.5_7+ f.sex.5_7+ f.edu_m_.0.5_7+ f.femp_cat_mom_0.5_7",
                           data = "ext_data",
                           family = "gaussian",
                           datasources = c.data[c('elfe')])
dh.lmTab(
  model = ext_5_6_adj_elfe, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")
###############################################################################################################
###############################################################################################################
################################# Forest plot #################################################################
estext_5_6_1 <-c((ext_5_6_adj_alspac$coefficients["f.cen_dur_cat.5_71", "Estimate"]),
                 (ext_5_6_adj_genr$coefficients["f.cen_dur_cat.5_71", "Estimate"]),
                 (ext_5_6_adj_eden$coefficients["f.cen_dur_cat.5_71", "Estimate"]),
                 (ext_5_6_adj_elfe$coefficients["f.cen_dur_cat.5_71", "Estimate"]),
                 
                 (ext_5_6_adj_genr$coefficients["f.cen_dur_cat.5_72", "Estimate"]),
                 (ext_5_6_adj_eden$coefficients["f.cen_dur_cat.5_72", "Estimate"]),
                 (ext_5_6_adj_elfe$coefficients["f.cen_dur_cat.5_72", "Estimate"]))



estext_5_6_1
# overall standard errors
seext_5_6_1 <-c((ext_5_6_adj_alspac$coefficients["f.cen_dur_cat.5_71", "Std. Error"]), 
                (ext_5_6_adj_genr$coefficients["f.cen_dur_cat.5_71", "Std. Error"]),
                (ext_5_6_adj_eden$coefficients["f.cen_dur_cat.5_71", "Std. Error"]),
                (ext_5_6_adj_elfe$coefficients["f.cen_dur_cat.5_71", "Std. Error"]),
                
                (ext_5_6_adj_genr$coefficients["f.cen_dur_cat.5_72", "Std. Error"]),
                (ext_5_6_adj_eden$coefficients["f.cen_dur_cat.5_72", "Std. Error"]),
                (ext_5_6_adj_elfe$coefficients["f.cen_dur_cat.5_72", "Std. Error"]))



ds.table('ext_data$f.cen_dur_cat.5_7', exclude=NA)

resextadj5_6 <- metafor::rma(yi=estext_5_6_1, sei=seext_5_6_1)
resextadj5_6
library('metafor')

mlabfundur5_6adj <- function(text, resextadj5_6) {
  list(bquote(paste(.(text),
                    ": Q = ", .(formatC(resextadj5_6$QE, digits=2, format="f")),
                    ", df = ", .(resextadj5_6$k - resextadj5_6$p),
                    ", p ", .(metafor:::.pval(resextadj5_6$QEp, digits=2, showeq=TRUE, sep=" ")), "; ",
                    I^2, " = ", .(formatC(resextadj5_6$I2, digits=1, format="f")), "%, ",
                    tau^2, " = ", .(formatC(resextadj5_6$tau2, digits=2, format="f")),";",
                    H^2, " = ", .(formatC(resextadj5_6$H2, digits=2, format="f")))))}



forest(resextadj5_6, showweights=FALSE,rows=c(8:5,3:1), cex=1.2, cex.lab=1, xlim=c(-60,30), addfit = FALSE,
       psize=1, header="Cohort study (N= Attended ECEC, %)",slab=c("ALSPAC (N=99, 6.39%)", "GenR (N=866, 60.26%)", "EDEN (N=203, 27.36 %)", "ELFE (N=2292, 21.15%)", "GenR (N=63, 4.38%)", "EDEN (N=60, 8.09 %)", "ELFE (N=1006, 9.28%)"), font=4)

op <- par(cex=1.0, font=2)


### switch to bold italic font
par(font=4)

### add text for the subgroups
text(-60, c(8.4,3.4), pos=4, c("Only one year ECEC attendance",
                               "Two years or more ECEC attendance"))


### set par back to the original settings
par(op)



### subgroups estimates
e.sub1_5_6_adjest<-c((ext_5_6_adj_alspac$coefficients["f.cen_dur_cat.5_71", "Estimate"]),
                     (ext_5_6_adj_genr$coefficients["f.cen_dur_cat.5_71", "Estimate"]),
                     (ext_5_6_adj_eden$coefficients["f.cen_dur_cat.5_71", "Estimate"]),
                     (ext_5_6_adj_elfe$coefficients["f.cen_dur_cat.5_71", "Estimate"]))

e.sub2_5_6_adjest <-c((ext_5_6_adj_genr$coefficients["f.cen_dur_cat.5_72", "Estimate"]),
                      (ext_5_6_adj_eden$coefficients["f.cen_dur_cat.5_72", "Estimate"]),
                      (ext_5_6_adj_elfe$coefficients["f.cen_dur_cat.5_72", "Estimate"]))


# subgroup standard errors
e.sub1_5_6_adjse<-c((ext_5_6_adj_alspac$coefficients["f.cen_dur_cat.5_71", "Std. Error"]), 
                    (ext_5_6_adj_genr$coefficients["f.cen_dur_cat.5_71", "Std. Error"]),
                    (ext_5_6_adj_eden$coefficients["f.cen_dur_cat.5_71", "Std. Error"]),
                    (ext_5_6_adj_elfe$coefficients["f.cen_dur_cat.5_71", "Std. Error"]))

e.sub2_5_6_adjse <-c((ext_5_6_adj_genr$coefficients["f.cen_dur_cat.5_72", "Std. Error"]),
                     (ext_5_6_adj_eden$coefficients["f.cen_dur_cat.5_72", "Std. Error"]),
                     (ext_5_6_adj_elfe$coefficients["f.cen_dur_cat.5_72", "Std. Error"]))


### fit random-effects model in the four subgroups
e.res.1.5_6adj <- rma(yi=e.sub1_5_6_adjest,sei= e.sub1_5_6_adjse)
e.res.2.5_6adj <- rma(yi=e.sub2_5_6_adjest,sei= e.sub2_5_6_adjse)

#forest(e.res.1.5_6adj,showweights=TRUE)



addpoly(e.res.1.5_6adj ,cex=1.2, cex.lab=1, row=4.0, mlab=mlabfundur5_6adj ("RE Model for one year ECEC attendance",e.res.1.5_6adj ))
# calculate weights
#forest(e.res.2.5_6adj,showweights=TRUE)

addpoly(e.res.2.5_6adj,cex=1.2, cex.lab=1, row= 0.4, mlab=mlabfundur5_6adj ("RE Model for two year ECEC attendance", e.res.2.5_6adj ))


text(16, 10,cex=1.2,font=2, c("Weights (%)"))
text(16, 8,cex=1.2,font=1, c("3.93%"))
text(16, 7,cex=1.2,font=1, c("13.59%"))
text(16, 6,cex=1.2,font=1, c("6.58%"))
text(16, 5,cex=1.2,font=1, c("75.90%"))
text(16, 4,cex=1.2,font=1, c("100.00%"))

text(16, 3,cex=1.2,font=1, c("31.05%"))
text(16, 2,cex=1.2,font=1, c("30.31%"))
text(16, 1,cex=1.2,font=1, c("38.64%"))
text(16, 0.4,cex=1.2,font=1, c("100.00%"))


ds.table('ext_data$f.cen_dur_cat.7_10', exclude=NA)

##############################################################################
##############################################################################
########################### 7 to 9 year age bracket
#alspac


ext_7_9_crude_alspac <- ds.glm(formula = "n.ext_pc_.7_10 ~ f.cen_dur_cat.7_10",
                               data = "ext_data",
                               family = "gaussian",
                               datasources = c.data[c('alspac')])
ext_7_9_crude_alspac
dh.lmTab(
  model = ext_7_9_crude_alspac, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")

#genr
ext_7_9_crude_genr <- ds.glm(formula = "n.ext_pc_.7_10 ~ f.cen_dur_cat.7_10",
                             data = "ext_data",
                             family = "gaussian",
                             datasources = c.data[c('generationR')])
ext_7_9_crude_genr
dh.lmTab(
  model = ext_7_9_crude_genr, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")

#dnbc
ext_7_9_crude_dnbc <- ds.glm(formula = "n.ext_pc_.7_10 ~ f.cen_dur_cat.7_10",
                             data = "ext_data",
                             family = "gaussian",
                             datasources = c.data[c('dnbc')])


dh.lmTab(
  model = ext_7_9_crude_dnbc, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")
ext_7_9_crude_dnbc
# INMA

ext_7_9_crude_inma<- ds.glm(formula = "n.ext_pc_.7_10 ~ f.cen_dur_cat.7_10",
                            data = "ext_data",
                            family = "gaussian",
                            datasources = c.data[c('INMA')])


dh.lmTab(
  model = ext_7_9_crude_inma, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")
ext_7_9_crude_inma
# EDEN

ext_7_9_crude_eden<- ds.glm(formula = "n.ext_pc_.7_10 ~ f.cen_dur_cat.7_10",
                            data = "ext_data",
                            family = "gaussian",
                            datasources = c.data[c('eden')])


dh.lmTab(
  model = ext_7_9_crude_eden, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")
ext_7_9_crude_eden
########################################################################################
########################################################################################
################### crude forest plot meta-analysis for age bracket 7-9 years###########

yext7_9 <-c((ext_7_9_crude_alspac$coefficients["f.cen_dur_cat.7_101", "Estimate"]),
            (ext_7_9_crude_genr$coefficients["f.cen_dur_cat.7_101", "Estimate"]),
            (ext_7_9_crude_dnbc$coefficients["f.cen_dur_cat.7_101", "Estimate"]),
            (ext_7_9_crude_inma$coefficients["f.cen_dur_cat.7_101", "Estimate"]),
            (ext_7_9_crude_eden$coefficients["f.cen_dur_cat.7_101", "Estimate"]),
            
            
            (ext_7_9_crude_genr$coefficients["f.cen_dur_cat.7_102", "Estimate"]),
            (ext_7_9_crude_inma$coefficients["f.cen_dur_cat.7_102", "Estimate"]),
            (ext_7_9_crude_eden$coefficients["f.cen_dur_cat.7_102", "Estimate"]))

yext7_9

seext7_9 <-c((ext_7_9_crude_alspac$coefficients["f.cen_dur_cat.7_101", "Std. Error"]),
             (ext_7_9_crude_genr$coefficients["f.cen_dur_cat.7_101", "Std. Error"]),
             (ext_7_9_crude_dnbc$coefficients["f.cen_dur_cat.7_101", "Std. Error"]),
             (ext_7_9_crude_inma$coefficients["f.cen_dur_cat.7_101", "Std. Error"]),
             (ext_7_9_crude_eden$coefficients["f.cen_dur_cat.7_101", "Std. Error"]),
             
             
             (ext_7_9_crude_genr$coefficients["f.cen_dur_cat.7_102", "Std. Error"]),
             (ext_7_9_crude_inma$coefficients["f.cen_dur_cat.7_102", "Std. Error"]),
             (ext_7_9_crude_eden$coefficients["f.cen_dur_cat.7_102", "Std. Error"]))


resext7_9 <- metafor::rma(yi=yext7_9, sei=seext7_9)
resext7_9
library('metafor')

mlabfun7_9 <- function(text, resext7_9) {
  list(bquote(paste(.(text),
                    ": Q = ", .(formatC(resext7_9$QE, digits=2, format="f")),
                    ", df = ", .(resext7_9$k - resext7_9$p),
                    ", p ", .(metafor:::.pval(resext7_9$QEp, digits=2, showeq=TRUE, sep=" ")), "; ",
                    I^2, " = ", .(formatC(resext7_9$I2, digits=1, format="f")), "%, ",
                    tau^2, " = ", .(formatC(resext7_9$tau2, digits=2, format="f")),";",
                    H^2, " = ", .(formatC(resext7_9$H2, digits=2, format="f")))))}
forest(resext7_9, showweights=FALSE,rows=c(9:5,3:1), cex=1.2, cex.lab=1, xlim=c(-60,30), addfit = FALSE,
       psize=1, header="Cohort study (N= Attended ECEC, %)",slab=c('ALSPAC (N=170, 6.35%)', 'GenR (N=797, 61.45%)', 'DNBC (N=7065, 24.89%)','INMA (N=332, 29.24%)', 'EDEN (N=98, 31.83%)', 'GenR (N=57, 4.39%)', 'INMA(N=360, 42.55%)', 'EDEN(N=52, 11.58%)'), font=4)


ds.table('ext_data$f.cen_dur_cat.7_10', exclude=NA)


op <- par(cex=1.0, font=2)


### switch to bold italic font
par(font=4)

### add text for the subgroups
text(-60, c(9.4,3.4), pos=4, c("One Year ECEC attendance",
                               "Two Years or more ECEC attendance"))


### set par back to the original settings
par(op)



### subgroups estimates

e.sub1_7_9_cruest <-c((ext_7_9_crude_alspac$coefficients["f.cen_dur_cat.7_101", "Estimate"]),
                      (ext_7_9_crude_genr$coefficients["f.cen_dur_cat.7_101", "Estimate"]),
                      (ext_7_9_crude_dnbc$coefficients["f.cen_dur_cat.7_101", "Estimate"]),
                      (ext_7_9_crude_inma$coefficients["f.cen_dur_cat.7_101", "Estimate"]),
                      (ext_7_9_crude_eden$coefficients["f.cen_dur_cat.7_101", "Estimate"]))


e.sub2_7_9_cruest<-c((ext_7_9_crude_genr$coefficients["f.cen_dur_cat.7_102", "Estimate"]),
                     (ext_7_9_crude_inma$coefficients["f.cen_dur_cat.7_102", "Estimate"]),
                     (ext_7_9_crude_eden$coefficients["f.cen_dur_cat.7_102", "Estimate"]))

# subgroup standard errors

e.sub1_7_9_crues <-c((ext_7_9_crude_alspac$coefficients["f.cen_dur_cat.7_101", "Std. Error"]),
                     (ext_7_9_crude_genr$coefficients["f.cen_dur_cat.7_101", "Std. Error"]),
                     (ext_7_9_crude_dnbc$coefficients["f.cen_dur_cat.7_101", "Std. Error"]),
                     (ext_7_9_crude_inma$coefficients["f.cen_dur_cat.7_101", "Std. Error"]),
                     (ext_7_9_crude_eden$coefficients["f.cen_dur_cat.7_101", "Std. Error"]))


e.sub2_7_9_crues <-c((ext_7_9_crude_genr$coefficients["f.cen_dur_cat.7_102", "Std. Error"]),
                     (ext_7_9_crude_inma$coefficients["f.cen_dur_cat.7_102", "Std. Error"]),
                     (ext_7_9_crude_eden$coefficients["f.cen_dur_cat.7_102", "Std. Error"]))


### fit random-effects model in the four subgroups
e.res.1.7_9cru <- rma(yi=e.sub1_7_9_cruest, sei=e.sub1_7_9_crues)
e.res.2.7_9cru <- rma(yi=e.sub2_7_9_cruest, sei=e.sub2_7_9_crues)
# calculate weights
#forest(e.res.1.7_9cru,showweights=TRUE,cex=1.5)
#forest(e.res.2.7_9cru,showweights=TRUE,cex=1.5)

addpoly(e.res.1.7_9cru,cex=1.2, cex.lab=1, row=4.0, mlab=mlabfun7_9 ("RE Model for one year ECEC attendance", e.res.1.7_9cru))

addpoly(e.res.2.7_9cru,cex=1.2, cex.lab=1, row= 0.4, mlab=mlabfun7_9("RE Model for two year ECEC attendance", e.res.2.7_9cru))



text(16, 11,cex=1.2,font=2, c("Weights (%)"))
text(16, 9,cex=1.2,font=1, c("8.26%"))
text(16, 8,cex=1.2,font=1, c("16.60%"))
text(16, 7,cex=1.2,font=1, c("65.24%"))
text(16, 6,cex=1.2,font=1, c("5.53%"))
text(16, 5,cex=1.2,font=1, c("4.37%"))
text(16, 4,cex=1.2,font=1, c("100.00%"))



text(16, 3,cex=1.2,font=1, c("29.37%"))
text(16, 2,cex=1.2,font=1, c("48.50%"))
text(16, 1,cex=1.2,font=1, c("22.13%"))
text(16, 0.4,cex=1.2,font=1, c("100.00%"))


##########################################################################################################
##########################################################################################################
###################### Adjusted analysis #################################################################

ext_7_9_adj_alspac <- ds.glm(formula = "n.ext_pc_.7_10 ~ f.cen_dur_cat.7_10+ n.birth_weight.7_10+ n.agebirth_m_y.7_10+f.fam_splitup.0.7_10+ f.only_child.7_10+ f.sex.7_10+ f.edu_m_.0.7_10+ f.mom.emp.dich.7_10",
                             data = "ext_data",
                             family = "gaussian",
                             datasources = c.data[c('alspac')])
ext_7_9_adj_alspac

dh.lmTab(
  model = ext_7_9_adj_alspac, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")

#genr
ext_7_9_adj_genr <- ds.glm(formula = "n.ext_pc_.7_10 ~ f.cen_dur_cat.7_10+ n.birth_weight.7_10+ n.agebirth_m_y.7_10+f.fam_splitup.0.7_10+ f.only_child.7_10+ f.sex.7_10+ f.edu_m_.0.7_10+ f.femp_cat_mom_0.7_10",
                           data = "ext_data",
                           family = "gaussian",
                           datasources = c.data[c('generationR')])

dh.lmTab(
  model = ext_7_9_adj_genr, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")

#dnbc
ext_7_9_adj_dnbc <- ds.glm(formula = "n.ext_pc_.7_10 ~ f.cen_dur_cat.7_10+f.fam_splitup.0.7_10+f.sex.7_10+f.femp_cat_mom_0.7_10+n.birth_weight.7_10+f.only_child.7_10+n.agebirth_m_y.7_10",
                           data = "ext_data",
                           family = "gaussian",
                           datasources = c.data[c('dnbc')])


dh.lmTab(
  model = ext_7_9_adj_dnbc, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")

# INMA

ext_7_9_adj_inma <- ds.glm(formula = "n.ext_pc_.7_10 ~ f.cen_dur_cat.7_10+ n.birth_weight.7_10+ n.agebirth_m_y.7_10+ f.only_child.7_10+ f.sex.7_10+ f.edu_m_.0.7_10+ f.femp_cat_mom_0.7_10",
                           data = "ext_data",
                           family = "gaussian",
                           datasources = c.data[c('INMA')])


dh.lmTab(
  model = ext_7_9_adj_inma, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")

# EDEN

ext_7_9_adj_eden <- ds.glm(formula = "n.ext_pc_.7_10 ~ f.cen_dur_cat.7_10+ n.birth_weight.7_10+ n.agebirth_m_y.7_10+f.fam_splitup.0.7_10+ f.only_child.7_10+ f.sex.7_10+ f.edu_m_.0.7_10+ f.femp_cat_mom_0.7_10",
                           data = "ext_data",
                           family = "gaussian",
                           datasources = c.data[c('eden')])


dh.lmTab(
  model = ext_7_9_adj_eden, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")

ext_7_9_adj_eden

yext7_9adj <-c((ext_7_9_adj_alspac$coefficients["f.cen_dur_cat.7_101", "Estimate"]),
               (ext_7_9_adj_genr$coefficients["f.cen_dur_cat.7_101", "Estimate"]),
               (ext_7_9_adj_dnbc$coefficients["f.cen_dur_cat.7_101", "Estimate"]),
               (ext_7_9_adj_inma$coefficients["f.cen_dur_cat.7_101", "Estimate"]),
               (ext_7_9_adj_eden$coefficients["f.cen_dur_cat.7_101", "Estimate"]),
               
               
               (ext_7_9_adj_genr$coefficients["f.cen_dur_cat.7_102", "Estimate"]),
               (ext_7_9_adj_inma$coefficients["f.cen_dur_cat.7_102", "Estimate"]),
               (ext_7_9_adj_eden$coefficients["f.cen_dur_cat.7_102", "Estimate"]))

yext7_9adj

seext7_9adj <-c((ext_7_9_adj_alspac$coefficients["f.cen_dur_cat.7_101", "Std. Error"]),
                (ext_7_9_adj_genr$coefficients["f.cen_dur_cat.7_101", "Std. Error"]),
                (ext_7_9_adj_dnbc$coefficients["f.cen_dur_cat.7_101", "Std. Error"]),
                (ext_7_9_adj_inma$coefficients["f.cen_dur_cat.7_101", "Std. Error"]),
                (ext_7_9_adj_eden$coefficients["f.cen_dur_cat.7_101", "Std. Error"]),
                
                
                (ext_7_9_adj_genr$coefficients["f.cen_dur_cat.7_102", "Std. Error"]),
                (ext_7_9_adj_inma$coefficients["f.cen_dur_cat.7_102", "Std. Error"]),
                (ext_7_9_adj_eden$coefficients["f.cen_dur_cat.7_102", "Std. Error"]))


resext7_9adj <- metafor::rma(yi=yext7_9adj, sei=seext7_9adj)
resext7_9adj

mlabfun7_9adj <- function(text, resext7_9adj) {
  list(bquote(paste(.(text),
                    ": Q = ", .(formatC(resext7_9adj$QE, digits=2, format="f")),
                    ", df = ", .(resext7_9adj$k - resext7_9adj$p),
                    ", p ", .(metafor:::.pval(resext7_9adj$QEp, digits=2, showeq=TRUE, sep=" ")), "; ",
                    I^2, " = ", .(formatC(resext7_9adj$I2, digits=1, format="f")), "%, ",
                    tau^2, " = ", .(formatC(resext7_9adj$tau2, digits=2, format="f")),";",
                    H^2, " = ", .(formatC(resext7_9adj$H2, digits=2, format="f")))))}

forest(resext7_9adj, showweights=FALSE,rows=c(9:5,3:1), cex=1.2, cex.lab=1, xlim=c(-60,30), addfit = FALSE,
       psize=1,header="Cohort study (N= Attended ECEC, %)",slab=c('ALSPAC (N=170, 6.35%)', 'GenR (N=797, 61.45%)', 'DNBC (N=7065, 24.89%)','INMA (N=332, 29.24%)', 'EDEN (N=98, 31.83%)', 'GenR (N=57, 4.39%)', 'INMA(N=360, 42.55%)', 'EDEN(N=52, 11.58%)'), font=4)




op <- par(cex=1.0, font=2)


### switch to bold italic font
par(font=4)

### add text for the subgroups
text(-60, c(9.4,3.4), pos=4, c("One Year ECEC attendance",
                               "Two Years or more ECEC attendance"))


### set par back to the original settings
par(op)



### subgroups estimates

e.sub1_7_9_adjest <-c((ext_7_9_adj_alspac$coefficients["f.cen_dur_cat.7_101", "Estimate"]),
                      (ext_7_9_adj_genr$coefficients["f.cen_dur_cat.7_101", "Estimate"]),
                      (ext_7_9_adj_dnbc$coefficients["f.cen_dur_cat.7_101", "Estimate"]),
                      (ext_7_9_adj_inma$coefficients["f.cen_dur_cat.7_101", "Estimate"]),
                      (ext_7_9_adj_eden$coefficients["f.cen_dur_cat.7_101", "Estimate"]))


e.sub2_7_9_adjest<-c((ext_7_9_adj_genr$coefficients["f.cen_dur_cat.7_102", "Estimate"]),
                     (ext_7_9_adj_inma$coefficients["f.cen_dur_cat.7_102", "Estimate"]),
                     (ext_7_9_adj_eden$coefficients["f.cen_dur_cat.7_102", "Estimate"]))

# subgroup standard errors

e.sub1_7_9_adjes <-c((ext_7_9_adj_alspac$coefficients["f.cen_dur_cat.7_101", "Std. Error"]),
                     (ext_7_9_adj_genr$coefficients["f.cen_dur_cat.7_101", "Std. Error"]),
                     (ext_7_9_adj_dnbc$coefficients["f.cen_dur_cat.7_101", "Std. Error"]),
                     (ext_7_9_adj_inma$coefficients["f.cen_dur_cat.7_101", "Std. Error"]),
                     (ext_7_9_adj_eden$coefficients["f.cen_dur_cat.7_101", "Std. Error"]))


e.sub2_7_9_adjes<-c((ext_7_9_adj_genr$coefficients["f.cen_dur_cat.7_102", "Std. Error"]),
                    (ext_7_9_adj_inma$coefficients["f.cen_dur_cat.7_102", "Std. Error"]),
                    (ext_7_9_adj_eden$coefficients["f.cen_dur_cat.7_102", "Std. Error"]))



### fit random-effects model in the four subgroups
e.res.1.7_9adj <- rma(yi=e.sub1_7_9_adjest, sei=e.sub1_7_9_adjes)
e.res.2.7_9adj <- rma(yi=e.sub2_7_9_adjest, sei=e.sub2_7_9_adjes)
# calculate weights
#forest(e.res.1.7_9adj,showweights=TRUE,cex=1.5)
#forest(e.res.2.7_9adj,showweights=TRUE,cex=1.5)

addpoly(e.res.1.7_9adj,cex=1.2, cex.lab=1, row=4.0, mlab=mlabfun7_9adj ("RE Model for one year ECEC attendance", e.res.1.7_9adj))

addpoly(e.res.2.7_9adj,cex=1.2, cex.lab=1, row= 0.4, mlab=mlabfun7_9adj("RE Model for two year ECEC attendance", e.res.2.7_9adj))



text(16, 11,cex=1.2,font=2, c("Weights (%)"))
text(16, 9,cex=1.2,font=1, c("14.01%"))
text(16, 8,cex=1.2,font=1, c("20.16%"))
text(16, 7,cex=1.2,font=1, c("47.52%"))
text(16, 6,cex=1.2,font=1, c("10.17%"))
text(16, 5,cex=1.2,font=1, c("8.13%"))
text(16, 4,cex=1.2,font=1, c("100.00%"))



text(16, 3,cex=1.2,font=1, c("28.97%"))
text(16, 2,cex=1.2,font=1, c("48.61%"))
text(16, 1,cex=1.2,font=1, c("22.42%"))
text(16, 0.4,cex=1.2,font=1, c("100.00%"))


#################################### 10 to 12 years old information #######################################

#alspac
ds.table('ext_data$f.cen_dur_cat.10_14', exclude=NA)
ds.table('ext_data$f.centre_care.10_14', exclude=NA)


ext_10_13_crude_alspac <- ds.glm(formula = "n.ext_pc_.10_14 ~ f.cen_dur_cat.10_14",
                                 data = "ext_data",
                                 family = "gaussian",
                                 datasources = c.data[c('alspac')])
ext_10_13_crude_alspac
dh.lmTab(
  model = ext_10_13_adj_alspac, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")

## not enough in the two year so have to use this variable
ds.asNumeric('ext_data$f.cen_dur_cat.10_14', newobj='genR1year.10_14', datasources=c.data[c('generationR')])

ds.recodeValues(var.name='genR1year.10_14', 
                values2replace.vector = c(2),
                new.values.vector = c(NA), newobj='e.genr1year.10_14', datasources=c.data[c('generationR')])

ds.dataFrame(x=c('ext_data', "e.genr1year.10_14"), newobj='ext_data', datasources=c.data[c('generationR')])




#genr
ext_10_13_crude_genr <- ds.glm(formula = "n.ext_pc_.10_14 ~ e.genr1year.10_14",
                               data = "ext_data",
                               family = "gaussian",
                               datasources = c.data[c('generationR')])
ext_10_13_crude_genr
dh.lmTab(
  model = ext_10_13_crude_genr, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")

ds.table('ext_data$e.genr1year.10_14', exclude=NA, datasources = c.data[c('generationR')])


#dnbc
ext_10_13_crude_dnbc <- ds.glm(formula = "n.ext_pc_.10_14 ~ f.cen_dur_cat.10_14",
                               data = "ext_data",
                               family = "gaussian",
                               datasources = c.data[c('dnbc')])

ext_10_13_crude_dnbc
dh.lmTab(
  model = ext_10_13_crude_dnbc, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")

# INMA

ext_10_13_crude_inma <- ds.glm(formula = "n.ext_pc_.10_14 ~ f.cen_dur_cat.10_14",
                               data = "ext_data",
                               family = "gaussian",
                               datasources = c.data[c('INMA')])

ext_10_13_crude_inma
dh.lmTab(
  model = ext_10_13_crude_inma, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")

# NINFEA

ext_10_13_crude_ninfea <- ds.glm(formula = "n.ext_pc_.10_14 ~ f.cen_dur_cat.10_14",
                                 data = "ext_data",
                                 family = "gaussian",
                                 datasources = c.data[c('ninfea')])

ext_10_13_crude_ninfea
dh.lmTab(
  model = ext_10_13_crude_ninfea, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")


yext10_13 <-c((ext_10_13_crude_alspac$coefficients["f.cen_dur_cat.10_141", "Estimate"]),
              (ext_10_13_crude_genr$coefficients["e.genr1year.10_14", "Estimate"]),
              (ext_10_13_crude_dnbc$coefficients["f.cen_dur_cat.10_141", "Estimate"]),
              (ext_10_13_crude_inma$coefficients["f.cen_dur_cat.10_141", "Estimate"]),
              (ext_10_13_crude_ninfea$coefficients["f.cen_dur_cat.10_141", "Estimate"]),
              
              
              
              (ext_10_13_crude_inma$coefficients["f.cen_dur_cat.10_142", "Estimate"]))

yext10_13

seext10_13 <-c((ext_10_13_crude_alspac$coefficients["f.cen_dur_cat.10_141", "Std. Error"]),
               (ext_10_13_crude_genr$coefficients["e.genr1year.10_14", "Std. Error"]),
               (ext_10_13_crude_dnbc$coefficients["f.cen_dur_cat.10_141", "Std. Error"]),
               (ext_10_13_crude_inma$coefficients["f.cen_dur_cat.10_141", "Std. Error"]),
               (ext_10_13_crude_ninfea$coefficients["f.cen_dur_cat.10_141", "Std. Error"]),
               
               
               
               (ext_10_13_crude_inma$coefficients["f.cen_dur_cat.10_142", "Std. Error"]))

resext10_13 <- metafor::rma(yi=yext10_13, sei=seext10_13)
resext10_13
library('metafor')




mlabfun10_13 <- function(text, resext10_13) {
  list(bquote(paste(.(text),
                    ": Q = ", .(formatC(resext10_13$QE, digits=2, format="f")),
                    ", df = ", .(resext10_13$k - resext10_13$p),
                    ", p ", .(metafor:::.pval(resext10_13$QEp, digits=2, showeq=TRUE, sep=" ")), "; ",
                    I^2, " = ", .(formatC(resext10_13$I2, digits=1, format="f")), "%, ",
                    tau^2, " = ", .(formatC(resext10_13$tau2, digits=2, format="f")),";",
                    H^2, " = ", .(formatC(resext10_13$H2, digits=2, format="f")))))}


forest(resext10_13,showweights=FALSE,rows=c(7:3,1), cex=1.2, cex.lab=1, xlim=c(-90,60), addfit = FALSE,
       psize=1, header="Cohort study (N= Attended ECEC, %)",slab=c('ALSPAC (N=58, 5.32%)', 'GenR (N=61, 59.20%)', 'DNBC (N=5364,26.15%)','INMA (N=177, 45.15%)', 'NINFEA (N=18,30.51%)', 'INMA(N=167, 42.60%)'), font=4)



op <- par(cex=1.0, font=2)


### switch to bold italic font
par(font=4)

### add text for the subgroups
text(-90, c(7.4,1.4), pos=4, c("One Year ECEC attendance",
                               "Two Years or more ECEC attendance"))


### set par back to the original settings
par(op)



### subgroups estimates


e.sub1_10_13_cruest<-c((ext_10_13_crude_alspac$coefficients["f.cen_dur_cat.10_141", "Estimate"]),
                       (ext_10_13_crude_genr$coefficients["e.genr1year.10_14", "Estimate"]),
                       (ext_10_13_crude_dnbc$coefficients["f.cen_dur_cat.10_141", "Estimate"]),
                       (ext_10_13_crude_inma$coefficients["f.cen_dur_cat.10_141", "Estimate"]),
                       (ext_10_13_crude_ninfea$coefficients["f.cen_dur_cat.10_141", "Estimate"]))

e.sub2_10_13_cruest <-(ext_10_13_crude_inma$coefficients["f.cen_dur_cat.10_142", "Estimate"])



e.sub1_10_13_crues <-c((ext_10_13_crude_alspac$coefficients["f.cen_dur_cat.10_141", "Std. Error"]),
                       (ext_10_13_crude_genr$coefficients["e.genr1year.10_14", "Std. Error"]),
                       (ext_10_13_crude_dnbc$coefficients["f.cen_dur_cat.10_141", "Std. Error"]),
                       (ext_10_13_crude_inma$coefficients["f.cen_dur_cat.10_141", "Std. Error"]),
                       (ext_10_13_crude_ninfea$coefficients["f.cen_dur_cat.10_141", "Std. Error"]))


e.sub2_10_13_crues<-(ext_10_13_crude_inma$coefficients["f.cen_dur_cat.10_142", "Std. Error"])










### fit random-effects model in the four subgroups
e.res.1.10_13cru <- rma(yi=e.sub1_10_13_cruest, sei=e.sub1_10_13_crues)
e.res.2.10_13cru <- rma(yi=e.sub2_10_13_cruest,sei= e.sub2_10_13_crues)
# calculate weights
#forest(e.res.1.10_13cru,showweights=TRUE,cex=1.5)
#forest(e.res.2.10_13cru,showweights=TRUE,cex=1.5)

addpoly(e.res.1.10_13cru,cex=1.2, cex.lab=1, row=2.0, mlab=mlabfun10_13 ("RE Model for one year ECEC attendance", e.res.1.10_13cru))

#addpoly(e.res.2.10_13cru,cex=1.2, cex.lab=1, row= 0.4, mlab=mlabfun10_13 ("RE Model for two year ECEC attendance", e.res.2.10_13cru))



text(38, 9,cex=1.2,font=2, c("Weights (%)"))
text(38, 7,cex=1.2,font=1, c("21.93%"))
text(38, 6,cex=1.2,font=1, c("17.38%"))
text(38, 5,cex=1.2,font=1, c("33.20%"))
text(38, 4,cex=1.2,font=1, c("18.31%"))
text(38, 3,cex=1.2,font=1, c("9.18%"))
text(38, 2,cex=1.2,font=1, c("100.00%"))


text(38, 1,cex=1.2,font=1, c("100.00%"))


################### adjusted model ###############################################################################

#alspac


ext_10_13_adj_alspac <- ds.glm(formula = "n.ext_pc_.10_14 ~ f.cen_dur_cat.10_14+ n.birth_weight.10_14+ n.agebirth_m_y.10_14+ f.fam_splitup.0.10_14+f.only_child.10_14+ f.sex.10_14+ f.edu_m_.0.10_14+ f.mom.emp.dich.10_14",
                               data = "ext_data",
                               family = "gaussian",
                               datasources = c.data[c('alspac')])
ext_10_13_adj_alspac
dh.lmTab(
  model = ext_10_13_adj_alspac, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")

#genr
ext_10_13_adj_genr <- ds.glm(formula = "n.ext_pc_.10_14 ~ e.genr1year.10_14+ n.birth_weight.10_14+ n.agebirth_m_y.10_14+ f.fam_splitup.0.10_14+f.only_child.10_14+ f.sex.10_14+ f.edu_m_.0.10_14+ f.femp_cat_mom_0.10_14",
                             data = "ext_data",
                             family = "gaussian",
                             datasources = c.data[c('generationR')])

dh.lmTab(
  model = ext_10_13_adj_genr, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")

#dnbc
ext_10_13_adj_dnbc <- ds.glm(formula = "n.ext_pc_.10_14 ~ f.cen_dur_cat.10_14+ n.birth_weight.10_14+ n.agebirth_m_y.10_14+ f.fam_splitup.0.10_14+f.only_child.10_14+ f.sex.10_14+ f.edu_m_.0.10_14+ f.femp_cat_mom_0.10_14",
                             data = "ext_data",
                             family = "gaussian",
                             datasources = c.data[c('dnbc')])


dh.lmTab(
  model = ext_10_13_adj_dnbc, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")

# INMA

ext_10_13_adj_inma <- ds.glm(formula = "n.ext_pc_.10_14 ~ f.cen_dur_cat.10_14+ n.birth_weight.10_14+ n.agebirth_m_y.10_14+f.only_child.10_14+ f.sex.10_14+ f.edu_m_.0.10_14+ f.femp_cat_mom_0.10_14",
                             data = "ext_data",
                             family = "gaussian",
                             datasources = c.data[c('INMA')])


dh.lmTab(
  model = ext_10_13_adj_inma, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")

# NINFEA  ### too low cell count to include mother's education

ext_10_13_adj_ninfea <- ds.glm(formula = "n.ext_pc_.10_14 ~ f.cen_dur_cat.10_14+ n.birth_weight.10_14+ n.agebirth_m_y.10_14+f.only_child.10_14+ f.sex.10_14+ f.femp_cat_mom_0.10_14",
                               data = "ext_data",
                               family = "gaussian",
                               datasources = c.data[c('ninfea')])


dh.lmTab(
  model = ext_10_13_adj_ninfea, 
  type = "glm_ipd", 
  direction = "wide", 
  ci_format  = "paste")

yext10_13adj <-c((ext_10_13_adj_alspac$coefficients["f.cen_dur_cat.10_141", "Estimate"]),
                 (ext_10_13_adj_genr$coefficients["e.genr1year.10_14", "Estimate"]),
                 (ext_10_13_adj_dnbc$coefficients["f.cen_dur_cat.10_141", "Estimate"]),
                 (ext_10_13_adj_inma$coefficients["f.cen_dur_cat.10_141", "Estimate"]),
                 (ext_10_13_adj_ninfea$coefficients["f.cen_dur_cat.10_141", "Estimate"]),
                 
                 
                 
                 (ext_10_13_adj_inma$coefficients["f.cen_dur_cat.10_142", "Estimate"]))

yext10_13adj

seext10_13adj <-c((ext_10_13_adj_alspac$coefficients["f.cen_dur_cat.10_141", "Std. Error"]),
                  (ext_10_13_adj_genr$coefficients["e.genr1year.10_14", "Std. Error"]),
                  (ext_10_13_adj_dnbc$coefficients["f.cen_dur_cat.10_141", "Std. Error"]),
                  (ext_10_13_adj_inma$coefficients["f.cen_dur_cat.10_141", "Std. Error"]),
                  (ext_10_13_adj_ninfea$coefficients["f.cen_dur_cat.10_141", "Std. Error"]),
                  
                  
                  
                  (ext_10_13_adj_inma$coefficients["f.cen_dur_cat.10_142", "Std. Error"]))

seext10_13adj

resext10_13adj <- metafor::rma(yi=yext10_13adj, sei=seext10_13adj)

resext10_13adj

madfun10_13adj <- function(text, resext10_13adj) {
  list(bquote(paste(.(text),
                    ": Q = ", .(formatC(resext10_13adj$QE, digits=2, format="f")),
                    ", df = ", .(resext10_13adj$k - resext10_13adj$p),
                    ", p ", .(metafor:::.pval(resext10_13adj$QEp, digits=2, showeq=TRUE, sep=" ")), "; ",
                    I^2, " = ", .(formatC(resext10_13adj$I2, digits=1, format="f")), "%, ",
                    tau^2, " = ", .(formatC(resext10_13adj$tau2, digits=2, format="f")),";",
                    H^2, " = ", .(formatC(resext10_13adj$H2, digits=2, format="f")))))}

forest(resext10_13adj,showweights=FALSE,rows=c(7:3,1), cex=1.2, cex.lab=1, xlim=c(-90,60), addfit = FALSE,
       psize=1, header="Cohort study (N= Attended ECEC, %)",slab=c('ALSPAC (N=58, 5.32%)', 'GenR (N=61, 59.20%)', 'DNBC (N=5364, 26.15%)','INMA (N=177, 45.15%)', 'NINFEA (N=18, 30.51%)', 'INMA(N=167, 42.60%)'), font=4)


op <- par(cex=1.0, font=2)


### switch to bold italic font
par(font=4)

### add text for the subgroups
text(-90, c(7.4,1.4), pos=4, c("One Year ECEC attendance",
                               "Two Years or more ECEC attendance"))


### set par back to the original settings
par(op)



### subgroups estimates


e.sub1_10_13_adjest<-c((ext_10_13_adj_alspac$coefficients["f.cen_dur_cat.10_141", "Estimate"]),
                       (ext_10_13_adj_genr$coefficients["e.genr1year.10_14", "Estimate"]),
                       (ext_10_13_adj_dnbc$coefficients["f.cen_dur_cat.10_141", "Estimate"]),
                       (ext_10_13_adj_inma$coefficients["f.cen_dur_cat.10_141", "Estimate"]),
                       (ext_10_13_adj_ninfea$coefficients["f.cen_dur_cat.10_141", "Estimate"]))

e.sub2_10_13_adjest<-(ext_10_13_adj_inma$coefficients["f.cen_dur_cat.10_142", "Estimate"])




e.sub1_10_13_adjes <-c((ext_10_13_adj_alspac$coefficients["f.cen_dur_cat.10_141", "Std. Error"]),
                       (ext_10_13_adj_genr$coefficients["e.genr1year.10_14", "Std. Error"]),
                       (ext_10_13_adj_dnbc$coefficients["f.cen_dur_cat.10_141", "Std. Error"]),
                       (ext_10_13_adj_inma$coefficients["f.cen_dur_cat.10_141", "Std. Error"]),
                       (ext_10_13_adj_ninfea$coefficients["f.cen_dur_cat.10_141", "Std. Error"]))


e.sub2_10_13_adjes<-(ext_10_13_adj_inma$coefficients["f.cen_dur_cat.10_142", "Std. Error"])





### fit random-effects model in the four subgroups
e.res.1.10_13adj<- rma(yi=e.sub1_10_13_adjest,sei= e.sub1_10_13_adjes)
e.res.2.10_13adj<- rma(yi=e.sub2_10_13_adjest, sei=e.sub2_10_13_adjes)

# calculate weights
#forest(e.res.1.10_13adj,showweights=TRUE,cex=1.5)
#forest(e.res.2.10_13adj,showweights=TRUE,cex=1.5)

addpoly(e.res.1.10_13adj,cex=1.2, cex.lab=1, row=2.0, mlab=madfun10_13adj ("RE Model for one year ECEC attendance", e.res.1.10_13adj))
#addpoly(e.res.2.10_13adj,cex=1.2, cex.lab=1, row= 0.4, mlab=madfun10_13adj ("RE Model for two year ECEC attendance", e.res.2.10_13adj))



text(39.5, 9,cex=1.2,font=2, c("Weights (%)"))
text(39, 7,cex=1.2,font=1, c("22.64%"))
text(39, 6,cex=1.2,font=1, c("12.64%"))
text(39, 5,cex=1.2,font=1, c("39.93%"))
text(39, 4,cex=1.2,font=1, c("18.15%"))
text(39, 3,cex=1.2,font=1, c("6.63%"))
text(39, 2,cex=1.2,font=1, c("100.00%"))

text(39, 1,cex=1.2,font=1, c("100.00%"))



i.res.1.5_6cru
i.res.1.7_9cru
i.res.1.10_13cru
i.res.2.5_6cru
i.res.2.7_9cru
i.res.2.10_13cru

# meta analyzed results forest plots
#### duration meta analysis code
## internalizing crude 
duration.int.crude <- tibble(
  age_bracket=c('5-6 years (N= 3470,23.60%)',
                '7-9 years (N= 8499,25.20%)',
                '10-13 years (N= 6463, 25.10%)',
                '5-6 years (N= 1129, 7.66%)',
                '7-9 years (N= 469, 1.38%)',
                '10-13 years (N= 167, 6.49%)'),
  estimates=c(-0.36, -1.69, -0.48, -5.11, -3.50, 1.90),
  low_ci=c(-1.99, -3.57, -4.46, -11.38, -7.39, -8.01),
  high_ci=c(1.27,0.18,3.51, 1.16, 0.39, 11.81),
  p_value=c(0.66,0.08,0.81, 0.11, 0.08, 0.71),
  studies=c('4','5','5','3', '3', '1'),
  heterogeneity=c(
    'Q=2.50, df=3, p=0.48; I^2=20.5%, H^2=1.26',
    'Q=6.07, df=4, p=0.19; I^2=38.5%, H^2=1.63',
    'Q=10.37, df=4, p=0.03; I^2=60.5%, H^2=2.53',
    'Q=6.31, df=2, p=0.04; I^2=74.6%, H^2=3.93',
    'Q=0.24, df=2, p=0.89; I^2=0.0%, H^2=1.00',
    'NA'))

png(
  file = "internalizing crude duration ECEC attendance.png",
  width = 50,
  height = 12,
  units = "cm",
  res = 300)
par(mar=c(5,0,0,0))
age_pos = -36
est_pos = -20
p_pos = -19
het_pos = 17
st_pos = 15
height = 12

forest(
  x = duration.int.crude %>% pull(estimates),
  ci.lb = duration.int.crude %>% pull(low_ci),
  ci.ub = duration.int.crude %>% pull(high_ci),
  slab = duration.int.crude %>% pull(age_bracket),
  rows=c(7:5,3:1),
  xlab = "Beta Coefficient (95% CI)",
  ilab =  cbind(
    duration.int.crude %>% pull(p_value),
    duration.int.crude %>% pull(heterogeneity),
    duration.int.crude %>% pull(studies)),
  textpos = c(age_pos, est_pos),
  ilab.xpos = c(p_pos, het_pos, st_pos),
  ilab.pos = 4,
  cex = 0.8,
  cex.axis = 0.8,
  refline = 0,
  xlim = c(-36.0, 28),
  ylim = c(0, height),
  alim = c(-15, 15),
  steps = 3,
  digits = c(2, 2),
  psize = 1.2,
  font = "arial")
text(age_pos,c(9,4), c("One Year ECEC attendance","Two Years or more ECEC attendance"), font=2, cex = 0.8, pos=4)
text(age_pos, height-1, "Age bracket (N attended ECEC, %)",font=2, cex = 0.8, pos = 4)
text(est_pos, height-1, "Estimate [95% CI]", font=2, cex = 0.8, pos = 2)
text(p_pos, height-1, "P-value",font=2, cex = 0.8, pos = 4)
text(st_pos-2, height-1, "Number of studies",font=2, cex = 0.8, pos = 4)
text(het_pos+3, height-1, "Heterogeneity",font=2, cex = 0.8, pos = 4)
dev.off()

## adjusted internalizing duration model
i.res.1.5_6adj
i.res.1.7_9adj
i.res.1.10_13adj
i.res.2.5_6adj
i.res.2.7_9adj
i.res.2.10_13adj

duration.int.adj <- tibble(
  age_bracket=c('5-6 years (N= 3470,23.60%)',
                '7-9 years (N= 8499,25.20%)',
                '10-13 years (N= 6463, 25.10%)',
                '5-6 years (N= 1129, 7.66%)',
                '7-9 years (N= 469, 1.38%)',
                '10-13 years (N= 167, 6.49%)'),
  estimates=c(-0.03, -1.31, 1.48, -3.69, -2.65,5.85),
  low_ci=c(-1.24, -3.26, -2.71, -12.22, -6.55, -4.21),
  high_ci=c(1.18,0.63, 5.66, 4.85, 1.25, 15.91),
  p_value=c(0.96,0.19,0.49, 0.40,0.18,0.25),
  studies=c('4','5','5','3', '3', '1'),
  heterogeneity=c(
    'Q=1.38, df=3, p=0.71; I^2=0.0%, H^2=1.00', 
    'Q=6.20, df=4, p=0.18; I^2=37.9%, H^2=1.61',
    'Q=9.83, df=4, p=0.04; I^2=61.7%, H^2=2.61',
    'Q=9.68, df=2, p<0.01; I^2=86.1%, H^2=7.21',
    'Q=0.07, df=2, p=0.96; I^2=0.0%, H^2= 1.00', 
    'NA'
      ))


png(
  file = "internalizing adjusted duration ECEC attendance.png",
  width = 50,
  height = 12,
  units = "cm",
  res = 300)
par(mar=c(5,0,0,0))
age_pos = -36
est_pos = -20
p_pos = -19
het_pos = 19
st_pos = 17
height = 12

forest(
  x = duration.int.adj %>% pull(estimates),
  ci.lb = duration.int.adj %>% pull(low_ci),
  ci.ub = duration.int.adj %>% pull(high_ci),
  slab = duration.int.adj %>% pull(age_bracket),
  rows=c(7:5,3:1),
  xlab = "Beta Coefficient (95% CI)",
  ilab =  cbind(
    duration.int.adj %>% pull(p_value),
    duration.int.adj %>% pull(heterogeneity),
    duration.int.adj %>% pull(studies)),
  textpos = c(age_pos, est_pos),
  ilab.xpos = c(p_pos, het_pos, st_pos),
  ilab.pos = 4,
  cex = 0.8,
  cex.axis = 0.8,
  refline = 0,
  xlim = c(-36.0, 28),
  ylim = c(0, height),
  alim = c(-13, 16),
  steps = 3,
  digits = c(2, 2),
  psize = 1.2,
  font = "arial")
text(age_pos,c(9,4), c("One Year ECEC attendance","Two Years or more ECEC attendance"), font=2, cex = 0.8, pos=4)
text(age_pos, height-1, "Age bracket (N attended ECEC, %)",font=2, cex = 0.8, pos = 4)
text(est_pos, height-1, "Estimate [95% CI]", font=2, cex = 0.8, pos = 2)
text(p_pos, height-1, "P-value",font=2, cex = 0.8, pos = 4)
text(st_pos-2, height-1, "Number of studies",font=2, cex = 0.8, pos = 4)
text(het_pos+3, height-1, "Heterogeneity",font=2, cex = 0.8, pos = 4)
dev.off()

## externalizing crude 




duration.ext.crude <- tibble(
  age_bracket=c('5-6 years (N= 3272, 23.40 %)',
                '7-9 years (N= 8482, 25.00%)',
                '10-13 years (N= 5930, 24.81%)',
                '5-6 years (N= 1069, 7.64%)',
                '7-9 years (N= 469, 1.38%)',
                '10-13 years (N= 167, 0.70%)'),
  estimates=c(-0.27, -1.94, -0.62, -5.39,-3.31, 2.03),
  low_ci=c(-1.69, -3.11, -4.75, -13.00, -7.26,-7.74),
  high_ci=c(1.16,-0.77, 3.50, 2.22, 0.63, 11.81),
  p_value=c(0.7,0.001,0.77,0.16,0.10,0.68),
  studies=c('4','5','5','3', '3', '1'),
  heterogeneity=c(
    'Q=4.58, df=3, p=0.21; I^2=11.1%, H^2=1.13',
    'Q=5.16, df=4, p=0.27; I^2=10.5%, H^2=1.12',
    'Q=10.44, df=4, p=0.03; I^2=65.7%, H^2=2.92',
    'Q=8.86, df=2, p=0.01; I^2=82.2%, H^2=5.63',
    'Q=0.97, df=2, p=0.61; I^2=0.0%, H^2=1.00',
    'NA'))





png(
  file = "externalizing crude duration ECEC attendance.png",
  width = 50,
  height = 12,
  units = "cm",
  res = 300)
par(mar=c(5,0,0,0))
age_pos = -36
est_pos = -20
p_pos = -19
het_pos = 17
st_pos = 15
height = 12

forest(
  x = duration.ext.crude %>% pull(estimates),
  ci.lb = duration.ext.crude %>% pull(low_ci),
  ci.ub = duration.ext.crude %>% pull(high_ci),
  slab = duration.ext.crude %>% pull(age_bracket),
  rows=c(7:5,3:1),
  xlab = "Beta Coefficient (95% CI)",
  ilab =  cbind(
    duration.ext.crude %>% pull(p_value),
    duration.ext.crude %>% pull(heterogeneity),
    duration.ext.crude %>% pull(studies)),
  textpos = c(age_pos, est_pos),
  ilab.xpos = c(p_pos, het_pos, st_pos),
  ilab.pos = 4,
  cex = 0.8,
  cex.axis = 0.8,
  refline = 0,
  xlim = c(-36.0, 28),
  ylim = c(0, height),
  alim = c(-14, 12),
  steps = 3,
  digits = c(2, 2),
  psize = 1.2,
  font = "arial")
text(age_pos,c(9,4), c("One Year ECEC attendance","Two Years or more ECEC attendance"), font=2, cex = 0.8, pos=4)
text(age_pos, height-1, "Age bracket (N attended ECEC, %)",font=2, cex = 0.8, pos = 4)
text(est_pos, height-1, "Estimate [95% CI]", font=2, cex = 0.8, pos = 2)
text(p_pos, height-1, "P-value",font=2, cex = 0.8, pos = 4)
text(st_pos-2, height-1, "Number of studies",font=2, cex = 0.8, pos = 4)
text(het_pos+3, height-1, "Heterogeneity",font=2, cex = 0.8, pos = 4)
dev.off()

## externalizing adjusted results 
e.res.1.5_6adj
e.res.1.7_9adj
e.res.1.10_13adj
e.res.2.5_6adj
e.res.2.7_9adj
e.res.2.10_13adJ


duration.ext.adj <- tibble(
  age_bracket=c('5-6 years (N= 3272, 23.40 %)',
                '7-9 years (N= 8482, 25.00%)',
                '10-13 years (N= 5930, 24.81%)',
                '5-6 years (N= 1069, 7.64%)',
                '7-9 years (N= 469, 1.38%)',
                '10-13 years (N= 167, 0.70%)'),
  estimates=c(0.78, -1.03,-0.62, -3.10, -1.48,2.03),
  low_ci=c(-0.40, -2.74,-4.75, -11.74, -5.46,-7.74),
  high_ci=c(1.96,0.67,3.50, 5.55, 2.50,11.81),
  p_value=c(0.20,0.23,0.60,0.48,0.47,0.48),
  studies=c('4','5','5','3', '3', '1'),
  heterogeneity=c(
    'Q=3.73, df=3, p=0.29; "I"^2=0.0% , "H"^2=1.00', 
    'Q=6.43, df=4, p=0.17; I^2=28.7% , H^2=1.40',
    'Q=10.44, df=4, p=0.03; I^2=65.7% , H^2=2.92', 
    'Q=10.54, df=2, p<0.001; I^2=86.5% , H^2=7.43',
    'Q=0.97, df=2, p=0.62; I^2=0.0%, H^2=1.00',
    'N'))






png(
  file = "externalizing adj duration ECEC attendance.png",
  width = 54,
  height = 12,
  units = "cm",
  res = 300)
par(mar=c(5,0,0,0))
age_pos = -36
est_pos = -20
p_pos = -19
het_pos = 19
st_pos = 17
height = 12

forest(
  x = duration.ext.adj %>% pull(estimates),
  ci.lb = duration.ext.adj %>% pull(low_ci),
  ci.ub = duration.ext.adj%>% pull(high_ci),
  slab = duration.ext.adj %>% pull(age_bracket),
  rows=c(7:5,3:1),
  xlab = "Beta Coefficient (95% CI)",
  ilab =  cbind(
    duration.ext.adj %>% pull(p_value),
    duration.ext.adj %>% pull(heterogeneity),
    duration.ext.adj %>% pull(studies)),
  textpos = c(age_pos, est_pos),
  ilab.xpos = c(p_pos, het_pos, st_pos),
  ilab.pos = 4,
  cex = 0.8,
  cex.axis = 0.8,
  refline = 0,
  xlim = c(-36.0, 28),
  ylim = c(0, height),
  alim = c(-12, 17),
  steps = 3,
  digits = c(2, 2),
  psize = 1.2,
  font = "arial")
text(age_pos,c(9,4), c("One Year ECEC attendance","Two Years or more ECEC attendance"), font=2, cex = 0.8, pos=4)
text(age_pos, height-1, "Age bracket (N attended ECEC, %)",font=2, cex = 0.8, pos = 4)
text(est_pos, height-1, "Estimate [95% CI]", font=2, cex = 0.8, pos = 2)
text(p_pos, height-1, "P-value",font=2, cex = 0.8, pos = 4)
text(st_pos-2, height-1, "Number of studies",font=2, cex = 0.8, pos = 4)
text(het_pos+3, height-1, "Heterogeneity",font=2, cex = 0.8, pos = 4)
dev.off()




